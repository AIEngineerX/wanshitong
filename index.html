<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wan Shi Tong's Library ‚Äî $WanShiTong</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #1a0a0a 0%, #3d2314 50%, #1a0a0a 100%);
      color: #e8d5b7;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .stars {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .star {
      position: absolute;
      background: #fff;
      border-radius: 50%;
      animation: twinkle 3s infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.25; }
      50% { opacity: 0.9; }
    }

    header {
      text-align: center;
      padding: 60px 20px 34px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
      position: relative;
      z-index: 1;
    }

    .owl-icon {
      width: 200px;
      height: 200px;
      margin: 0 auto 18px;
      border-radius: 50%;
      overflow: hidden;
      border: 4px solid #daa520;
      box-shadow: 0 0 30px rgba(218, 165, 32, 0.5);
      animation: float 3s ease-in-out infinite;
      position: relative;
    }

    .owl-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center top;
      display: block;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      letter-spacing: 3px;
    }

    .subtitle {
      font-style: italic;
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 18px;
    }

    .warning {
      background: rgba(139, 0, 0, 0.3);
      border: 2px solid #8b0000;
      padding: 15px;
      max-width: 780px;
      margin: 14px auto 0;
      border-radius: 7px;
      font-size: 0.95em;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 34px 20px 50px;
      position: relative;
      z-index: 1;
    }

    /* ===== Hover Lore ===== */
    .lore-trigger { position: relative; }
    .lore-popover {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: calc(100% + 14px);
      width: min(560px, calc(100vw - 40px));
      background: rgba(0,0,0,0.78);
      border: 2px solid #8b6914;
      border-radius: 10px;
      padding: 18px 18px 14px;
      box-shadow: 0 12px 35px rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 20;
    }
    .lore-title {
      color: #daa520;
      font-weight: bold;
      letter-spacing: 1px;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-size: 0.95em;
    }
    .lore-text {
      line-height: 1.6;
      font-size: 1.05em;
      color: #e8d5b7;
      min-height: 64px;
      white-space: pre-wrap;
    }
    .lore-hint {
      margin-top: 10px;
      opacity: 0.82;
      font-size: 0.9em;
      color: #e8d5b7;
      border-top: 1px solid rgba(218,165,32,0.25);
      padding-top: 10px;
    }
    .lore-trigger:hover .lore-popover,
    .lore-trigger:focus-within .lore-popover {
      opacity: 1;
      pointer-events: auto;
    }
    .lore-popover::before {
      content: "";
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 14px;
      height: 14px;
      background: rgba(0,0,0,0.78);
      border-left: 2px solid #8b6914;
      border-top: 2px solid #8b6914;
    }

    /* ===== Token Landing ===== */
    .token-hero { margin: 0 0 26px; }
    .token-card {
      background: rgba(61, 35, 20, 0.6);
      border: 2px solid #8b6914;
      border-radius: 12px;
      padding: 28px;
      backdrop-filter: blur(6px);
    }
    .token-row {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .token-kicker {
      opacity: 0.85;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 0.9em;
      margin-bottom: 6px;
    }
    .token-name {
      font-size: 2.6em;
      color: #daa520;
      letter-spacing: 3px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    .token-tagline { opacity: 0.95; margin-top: 6px; max-width: 70ch; }
    .token-actions { display: flex; gap: 12px; flex-wrap: wrap; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #8b6914;
      background: rgba(0,0,0,0.35);
      color: #e8d5b7;
      text-decoration: none;
      font-weight: bold;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      cursor: pointer;
      font-family: 'Georgia', serif;
    }
    .btn:hover { transform: translateY(-2px); border-color: #daa520; background: rgba(0,0,0,0.5); }
    .btn.primary { background: #8b6914; border-color: #8b6914; }
    .btn.primary:hover { background: #daa520; border-color: #daa520; }
    .btn.small { padding: 10px 14px; font-size: 0.95em; }

    .ca-box {
      margin-top: 18px;
      background: rgba(0,0,0,0.35);
      border: 2px solid rgba(218,165,32,0.35);
      border-radius: 10px;
      padding: 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px 12px;
      align-items: center;
    }
    .ca-label { opacity: 0.9; color: #daa520; font-weight: bold; }
    .ca-value {
      grid-column: 1 / -1;
      font-family: 'Courier New', monospace;
      font-size: 0.95em;
      word-break: break-all;
      padding: 10px;
      border-radius: 8px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(218,165,32,0.25);
    }
    .copy-status { opacity: 0.9; font-size: 0.9em; justify-self: end; }

    .token-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 14px;
      margin-top: 18px;
    }
    .stat {
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(218,165,32,0.22);
      border-radius: 10px;
      padding: 14px;
    }
    .stat-label { opacity: 0.85; font-size: 0.95em; }
    .stat-value { color: #daa520; font-weight: bold; margin-top: 6px; font-size: 1.05em; }

    .links-row {
      margin-top: 18px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      border: 2px solid rgba(218,165,32,0.25);
      background: rgba(0,0,0,0.3);
      color: #e8d5b7;
      text-decoration: none;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .pill:hover { transform: translateY(-2px); border-color: #daa520; }

    .disclaimer {
      margin-top: 18px;
      opacity: 0.85;
      font-size: 0.95em;
      border-top: 1px solid rgba(218,165,32,0.22);
      padding-top: 14px;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 22px;
      margin: 18px 0 40px;
    }
    .panel {
      background: rgba(61, 35, 20, 0.55);
      border: 2px solid #8b6914;
      border-radius: 12px;
      padding: 22px;
      backdrop-filter: blur(5px);
    }
    .panel h3 { color: #daa520; margin-bottom: 12px; font-size: 1.5em; }
    .clean-list { list-style: none; padding-left: 0; }
    .clean-list li {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(218,165,32,0.18);
    }
    .clean-list li:last-child { border-bottom: none; }
    .steps { margin-left: 18px; }
    .steps li { margin: 10px 0; line-height: 1.55; }
    .roadmap { display: grid; gap: 12px; }
    .milestone {
      padding: 12px;
      border-radius: 10px;
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(218,165,32,0.22);
      line-height: 1.55;
    }
    .milestone span {
      display: inline-block;
      margin-right: 10px;
      color: #daa520;
      font-weight: bold;
    }
    .muted { opacity: 0.9; line-height: 1.6; }

    /* Original content sections */
    .knowledge-sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 50px;
    }

    .section {
      background: rgba(61, 35, 20, 0.6);
      border: 2px solid #8b6914;
      border-radius: 10px;
      padding: 30px;
      transition: all 0.3s ease;
      cursor: pointer;
      backdrop-filter: blur(5px);
    }

    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(139, 105, 20, 0.4);
      border-color: #daa520;
    }

    .section h2 {
      color: #daa520;
      margin-bottom: 15px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-icon { font-size: 1.3em; }
    .section p { line-height: 1.6; opacity: 0.9; }

    .quote-section {
      background: rgba(0, 0, 0, 0.5);
      border-left: 4px solid #daa520;
      padding: 30px;
      margin: 50px 0;
      border-radius: 5px;
    }

    .quote {
      font-size: 1.3em;
      font-style: italic;
      text-align: center;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .quote-author {
      text-align: right;
      color: #daa520;
      font-weight: bold;
    }

    .knowledge-form {
      background: rgba(61, 35, 20, 0.6);
      border: 2px solid #8b6914;
      border-radius: 10px;
      padding: 40px;
      max-width: 720px;
      margin: 50px auto 30px;
    }

    .knowledge-form h3 {
      color: #daa520;
      margin-bottom: 14px;
      font-size: 1.8em;
      text-align: center;
    }

    .form-group { margin-bottom: 20px; }
    label {
      display: block;
      margin-bottom: 8px;
      color: #daa520;
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid #8b6914;
      border-radius: 5px;
      color: #e8d5b7;
      font-family: 'Georgia', serif;
      font-size: 1em;
    }

    input:focus, textarea:focus { outline: none; border-color: #daa520; }
    textarea { resize: vertical; min-height: 120px; }

    button {
      background: #8b6914;
      color: #e8d5b7;
      border: none;
      padding: 15px 40px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Georgia', serif;
      width: 100%;
      font-weight: bold;
    }

    button:hover {
      background: #daa520;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4);
    }

    .submission-message {
      background: rgba(0, 0, 0, 0.55);
      border: 2px solid rgba(218, 165, 32, 0.35);
      padding: 15px;
      border-radius: 8px;
      margin-top: 18px;
      text-align: left;
      display: none;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    footer {
      text-align: center;
      padding: 40px 20px;
      opacity: 0.7;
      font-size: 0.9em;
      z-index: 1;
      position: relative;
    }

    @media (max-width: 520px) {
      h1 { font-size: 2.2em; }
      .token-name { font-size: 2.1em; }
      .token-card { padding: 22px; }
    }
  /* ===== Layout Cleanup (Cards) ===== */
.knowledge-sections {
  align-items: stretch;
  justify-items: stretch;
}
.section {
  min-height: 270px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.section h2 { margin-bottom: 8px; }
.section p { margin-top: 0; }
@media (max-width: 980px) {
  .section { min-height: auto; }
}
  </style>
</head>

<body>
  <div class="stars" id="stars"></div>

  <header>
    <div class="owl-icon lore-trigger" id="loreTrigger" tabindex="0">
      <img src="wan-shi-tong.png" alt="Wan Shi Tong" />
      <div class="lore-popover" id="lorePopover" aria-hidden="true">
        <div class="lore-title">The Librarian‚Äôs Oath</div>
        <div class="lore-text" id="loreText"></div>
        <div class="lore-hint">Hover to listen. Click to seal your offering.</div>
      </div>
    </div>

    <h1>WAN SHI TONG</h1>
    <p class="subtitle">He Who Knows Ten Thousand Things</p>
    <div class="warning">‚ö†Ô∏è Those who seek knowledge for destructive purposes will be cast out into the desert</div>
  </header>

  <div class="container">

    <section class="token-hero">
      <div class="token-card">
        <div class="token-row">
          <div>
            <div class="token-kicker">The Library Opens</div>
            <div class="token-name">$WanShiTong</div>
            <div class="token-tagline">He Who Knows Ten Thousand Things ‚Äî now guarding your bags as $WanShiTong.</div>
          </div>

          <div class="token-actions">
            <a class="btn primary" href="#" id="buyBtn">Buy on DEX</a>
            <a class="btn" href="#" id="chartBtn">View Chart</a>
          </div>
        </div>

        <div class="ca-box">
          <div class="ca-label">Contract Address</div>
          <div class="ca-value" id="caValue">DzmMSKtWmc2vhDxEcD5EH5Qr1MZNYJYZ8uE3UHaxpump</div>
          <button class="btn small" type="button" id="copyCa">Copy</button>
          <span class="copy-status" id="copyStatus" aria-live="polite"></span>
        </div>

        <div class="token-stats">
          <div class="stat">
            <div class="stat-label">Chain</div>
            <div class="stat-value">Solana</div>
          </div>
          <div class="stat">
            <div class="stat-label">Supply</div>
            <div class="stat-value">1,000,000,000</div>
          </div>
          <div class="stat">
            <div class="stat-label">Tax</div>
            <div class="stat-value">0/0</div>
          </div>
          <div class="stat">
            <div class="stat-label">LP</div>
            <div class="stat-value">Burned / Locked</div>
          </div>
        </div>

        <div class="links-row">
          <a class="pill" href="#" id="xLink">X / Community</a>
<a class="pill" href="#" id="dexLink">Dexscreener</a>
</div>

        <div class="disclaimer">
          <strong>Wan Shi Tong warns:</strong> Knowledge is given freely, but consequences are not. Enter this library of your own will, and bear the results of what you seek.
        </div>
      </div>
    </section>

    <section class="token-grid">
      <div class="panel">
        <h3>Tokenomics</h3>
        <ul class="clean-list">
          <li><span>Supply:</span> <strong>1B</strong></li>
          <li><span>Liquidity:</span> <strong>Fair launch</strong></li>
          <li><span>Taxes:</span> <strong>0%</strong></li>
          <li><span>Allocation:</span> <strong>100% community</strong></li>
        </ul>
        <p class="muted">The only utility is knowledge, vibes, and the meme. The only rule: don‚Äôt bring war.</p>
      </div>

      <div class="panel">
        <h3>How to Buy</h3>
        <ol class="steps">
          <li>Get SOL in your wallet (Phantom, Backpack).</li>
          <li>Open the DEX and paste the Contract Address.</li>
          <li>Swap SOL ‚Üí <strong>$WanShiTong</strong>.</li>
          <li>Offer knowledge. Share memes. Protect the library.</li>
        </ol>
      </div>

      <div class="panel">
        <h3>Roadmap</h3>
        <div class="roadmap">
          <div class="milestone"><span>Phase I</span> Summon the Scholars (launch, socials, memes)</div>
          <div class="milestone"><span>Phase II</span> The Archive Expands (lore drops, raids, community quests)</div>
          <div class="milestone"><span>Phase III</span> Ten Thousand Things (oracle responses, lore drops, and community quests)</div>
        </div>
      </div>
<div class="lore-text">
      "Knowledge is not a weapon. It is a trust."
‚Äî Wan Shi Tong
    </div>
  </div>
</div>


    </section>

    <div class="knowledge-sections">
      <div class="section">
        <h2><span class="section-icon">üìö</span> Ancient Texts</h2>
        <p>Scrolls, codices, and forgotten chronicles gathered by the <em>Knowledge Seekers</em>‚Äîfox spirits who roam the world retrieving what mortals misplace. Every volume is cataloged, sealed, and remembered.</p>
      </div>

      <div class="section">
        <h2><span class="section-icon">üåç</span> Geography & Maps</h2>
        <p>Cartography of all four nations, hidden oases of the Si Wong Desert, and routes only spirits remember. Some maps lead to rooms that do not appear twice‚Äîunless the library wills it.</p>
      </div>

      <div class="section">
        <h2><span class="section-icon">‚öóÔ∏è</span> Natural Philosophy</h2>
        <p>Astronomy, alchemy, biology, and the celestial mechanics of the world‚Äîlike the ancient calendar that revealed the <em>Day of Black Sun</em>. Knowledge here is precise, not kind.</p>
      </div>

      <div class="section">
        <h2><span class="section-icon">üé≠</span> Arts & Culture</h2>
        <p>Poetry, music, theater, and the living record of civilizations. A library is not merely facts‚Äîit is the memory of a people, preserved against the erasure of war.</p>
      </div>

      <div class="section">
        <h2><span class="section-icon">‚öîÔ∏è</span> History & Warfare</h2>
        <p>Treaties, dynasties, and the rise and fall of empires‚Äîkept for truth, not conquest. Seek strategy to harm others and you will be cast out into the sands.</p>
      </div>

      <div class="section">
        <h2><span class="section-icon">‚ú®</span> Spirit World Lore</h2>
        <p>Archives of spirits, portals, and the delicate balance between realms. The library is a bridge between worlds‚Äîonce buried in the desert, now beyond the physical, where only worthy offerings open doors.</p>
      </div>
    </div>

    <div class="quote-section">
      <p class="quote">"You think you are the first person to believe their war was justified? Countless others before you have come here seeking weapons, weaknesses, battle strategies."</p>
      <p class="quote-author">‚Äî Wan Shi Tong</p>
    </div>

    <div class="knowledge-form">
      <h3>Contribute Knowledge</h3>
      <p style="text-align: center; margin-bottom: 22px; opacity: 0.9;">
        Entry to my library requires payment in the form of knowledge I do not possess.
      </p>

      <form id="knowledgeForm">
        <div class="form-group">
          <label for="name">Your Name:</label>
          <input type="text" id="name" required />
        </div>
        <div class="form-group">
          <label for="knowledge">What Knowledge Do You Bring?</label>
          <textarea id="knowledge" required placeholder="Share something unique, something I have not yet collected..."></textarea>
        </div>
        <button type="submit" id="offerBtn">Present Your Offering</button>

        <div class="submission-message" id="aiReply"></div>
      </form>
    </div>

  </div>

        <section class="token-grid" id="model3d">
      <div class="panel" style="grid-column: 1 / -1;">
        <h3>Explore the Archivist</h3>
        <p class="muted" style="margin-bottom: 18px;">
          A small window into the Spirit World. Drag to rotate, scroll to zoom. If the model files are not present, you will see a notice below.
        </p>

        <div style="display:grid; grid-template-columns: 1fr; gap: 14px;">
          <div id="modelWrap" style="width:100%; aspect-ratio: 16 / 10; border-radius: 12px; border: 2px solid #8b6914; background: rgba(0,0,0,0.3); overflow:hidden; position:relative;">
            <canvas id="modelCanvas" style="width:100%; height:100%; display:block;"></canvas>
            <div id="modelStatus" style="position:absolute; left:12px; bottom:12px; right:12px; background: rgba(0,0,0,0.55); border: 1px solid rgba(218,165,32,0.25); border-radius: 10px; padding: 10px 12px; font-size: 0.95em; line-height: 1.4; display:none;"></div>
          </div>

          <div class="disclaimer" style="margin-top: 0; font-size: 0.9em;">
            <strong>Setup:</strong> Place your OBJ/MTL/texture files in <code>/models/</code> and update the paths in the script (search for <code>MODEL_PATHS</code>). This viewer loads assets client-side.
          </div>
        </div>
      </div>
    </section>


  <footer>
    <p>The Library exists beyond the physical realm, in the Si Wong Desert</p>
    <p>Guarded eternally by the Knowledge Seekers</p>
  </footer>

  <script>
    // ===== Stars =====
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 100; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.width = (Math.random() * 3 + 1) + 'px';
      star.style.height = star.style.width;
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 3 + 's';
      starsContainer.appendChild(star);
    }

    // ===== Hover Lore Typewriter =====
    const loreLines = [
      "I am Wan Shi Tong. I collect knowledge.",
      "Bring me something I do not know‚Ä¶ and you may enter.",
      "Seek weapons, and I will cast you into the desert.",
      "Seek alpha, and I will test your intent.",
      "In this library, the only currency is truth."
    ];

    const loreTextEl = document.getElementById('loreText');
    const loreTrigger = document.getElementById('loreTrigger');

    let loreIndex = 0;
    let typing = false;
    let typeTimer = null;

    function typeLine(line) {
      typing = true;
      loreTextEl.textContent = "";
      let i = 0;
      clearInterval(typeTimer);
      typeTimer = setInterval(() => {
        loreTextEl.textContent += line.charAt(i);
        i++;
        if (i >= line.length) {
          clearInterval(typeTimer);
          typing = false;
        }
      }, 22);
    }

    function nextLore() {
      if (typing) return;
      typeLine(loreLines[loreIndex % loreLines.length]);
      loreIndex++;
    }

    loreTrigger.addEventListener('mouseenter', nextLore);
    loreTrigger.addEventListener('focusin', nextLore);
    loreTrigger.addEventListener('click', () => {
      if (typing) {
        clearInterval(typeTimer);
        typing = false;
      } else {
        nextLore();
      }
    });

    // Initialize first line
    typeLine(loreLines[0]);
    loreIndex = 1;

    // ===== Contract Address Copy =====
    const copyBtn = document.getElementById('copyCa');
    const caValue = document.getElementById('caValue');
    const copyStatus = document.getElementById('copyStatus');

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(caValue.textContent.trim());
        copyStatus.textContent = "Copied.";
        setTimeout(() => (copyStatus.textContent = ""), 1500);
      } catch (e) {
        copyStatus.textContent = "Copy failed. Select and copy manually.";
        setTimeout(() => (copyStatus.textContent = ""), 2500);
      }
    });

    // ===== Link wiring =====
    const LINKS = {
      buy: "#",      // Add your Jupiter/Raydium swap URL here
      chart: "https://dexscreener.com/solana/gb1dccxamrtdcw1zhhd6nu3mrdxalzdgyld8qfcr2mwn",    // Dexscreener chart
      x: "https://x.com/i/communities/2002918673451831748",
      tg: "#",       // Add your Telegram invite here
      dex: "https://dexscreener.com/solana/gb1dccxamrtdcw1zhhd6nu3mrdxalzdgyld8qfcr2mwn",      // Dexscreener link
    };

    document.getElementById('buyBtn').setAttribute('href', LINKS.buy);
    document.getElementById('chartBtn').setAttribute('href', LINKS.chart);
    document.getElementById('xLink').setAttribute('href', LINKS.x);
    document.getElementById('dexLink').setAttribute('href', LINKS.dex);

    ['buyBtn','chartBtn','xLink','dexLink'].forEach(id => {
      const el = document.getElementById(id);
      el.setAttribute('target', '_blank');
      el.setAttribute('rel', 'noopener noreferrer');
    });

    // ===== AI Offering (Netlify Function) =====
    const form = document.getElementById('knowledgeForm');
    const aiReply = document.getElementById('aiReply');
    const offerBtn = document.getElementById('offerBtn');

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const knowledge = document.getElementById('knowledge').value.trim();

      aiReply.style.display = 'block';
      aiReply.textContent = 'The Librarian considers your offering...';
      offerBtn.disabled = true;
      offerBtn.textContent = 'Judging...';

      try {
        const endpoint = '/.netlify/functions/knowledge';
        // If you're previewing from a local file (file://), Netlify Functions won't exist.
        if (location.protocol === 'file:') {
          throw new Error('Local preview cannot call Netlify Functions. Deploy to Netlify to enable the Librarian.');
        }

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, knowledge })
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch (_) {}

        if (!res.ok) {
          const msg = (data && (data.reply || data.error)) ? (data.reply || data.error) : `Function error (${res.status}).`;
          throw new Error(msg + (text ? `\n${text}` : ''));
        }

        aiReply.textContent = (data && data.reply) ? data.reply : (text || 'The Library is silent.');
      } catch (err) {
        aiReply.textContent = 'The sands interfere‚Ä¶ try again later.';
      } finally {
        offerBtn.disabled = false;
        offerBtn.textContent = 'Present Your Offering';
      }
    });

    // ===== Section click feedback =====
    document.querySelectorAll('.section').forEach(section => {
      section.addEventListener('click', function() {
        this.style.background = 'rgba(61, 35, 20, 0.8)';
        setTimeout(() => {
          this.style.background = 'rgba(61, 35, 20, 0.6)';
        }, 200);
      });
    });
  
    // ===== PFP / Meme Generator (Client-side Canvas) =====
(function() {
  const upload = document.getElementById('pfpUpload');
  const canvas = document.getElementById('pfpCanvas');
  const resetBtn = document.getElementById('pfpReset');
  const dlBtn = document.getElementById('pfpDownload');
  const textInput = document.getElementById('pfpText');
  const clearTextBtn = document.getElementById('pfpClearText');
  const stickerBar = document.getElementById('pfpStickers');
  const presetsBar = document.getElementById('pfpPresets');

  if (!upload || !canvas || !stickerBar) return;

  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const state = {
    baseImg: null,
    baseCrop: { sx:0, sy:0, s:1 },
    textMode: 'bottom', // top | bottom | both
    frame: 'gold',      // none | gold | seal
    stickers: [],       // {img, x,y, w,h, rot, id, key}
    selectedId: null
  };

  const svgSticker = (svg) => 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));

  // Lore sticker pack (all inline SVG; no external assets; runs 100% client-side)
  const STICKERS = [
    { key: 'owl_eyes', label: 'Owl Eyes', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="360" height="180" viewBox="0 0 360 180">
      <defs>
        <radialGradient id="g" cx="50%" cy="50%" r="60%">
          <stop offset="0%" stop-color="#daa520" stop-opacity="0.95"/>
          <stop offset="55%" stop-color="#daa520" stop-opacity="0.35"/>
          <stop offset="100%" stop-color="#000" stop-opacity="0"/>
        </radialGradient>
      </defs>
      <ellipse cx="110" cy="95" rx="88" ry="64" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
      <ellipse cx="250" cy="95" rx="88" ry="64" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
      <circle cx="110" cy="95" r="44" fill="url(#g)"/>
      <circle cx="250" cy="95" r="44" fill="url(#g)"/>
      <circle cx="110" cy="95" r="16" fill="rgba(0,0,0,0.7)"/>
      <circle cx="250" cy="95" r="16" fill="rgba(0,0,0,0.7)"/>
      <circle cx="102" cy="88" r="6" fill="rgba(255,255,255,0.5)"/>
      <circle cx="242" cy="88" r="6" fill="rgba(255,255,255,0.5)"/>
    </svg>`) },
    { key: 'sigil', label: 'Sigil', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="220" height="220" viewBox="0 0 220 220">
      <circle cx="110" cy="110" r="96" fill="rgba(0,0,0,0.45)" stroke="#daa520" stroke-width="10"/>
      <path d="M110 35 L145 95 L110 185 L75 95 Z" fill="none" stroke="#daa520" stroke-width="10" stroke-linejoin="round"/>
      <circle cx="110" cy="110" r="10" fill="#daa520"/>
    </svg>`) },
    { key: 'feather_crown', label: 'Feather Crown', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="360" height="210" viewBox="0 0 360 210">
      <path d="M55 165 C95 80, 140 80, 180 165 C220 80, 265 80, 305 165" fill="none" stroke="#daa520" stroke-width="12" stroke-linecap="round"/>
      <path d="M70 160 C90 120, 120 120, 140 160" fill="none" stroke="rgba(232,213,183,0.65)" stroke-width="8" stroke-linecap="round"/>
      <path d="M220 160 C240 120, 270 120, 290 160" fill="none" stroke="rgba(232,213,183,0.65)" stroke-width="8" stroke-linecap="round"/>
      <circle cx="180" cy="165" r="22" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
    </svg>`) },
    { key: 'scroll', label: 'Scroll', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="260" height="180" viewBox="0 0 260 180">
      <rect x="40" y="35" width="180" height="110" rx="16" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="8"/>
      <path d="M70 70 H190" stroke="#e8d5b7" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
      <path d="M70 95 H175" stroke="#e8d5b7" stroke-width="8" stroke-linecap="round" opacity="0.8"/>
      <path d="M70 120 H160" stroke="#e8d5b7" stroke-width="8" stroke-linecap="round" opacity="0.7"/>
      <circle cx="40" cy="90" r="22" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="8"/>
      <circle cx="220" cy="90" r="22" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="8"/>
    </svg>`) },
    { key: 'tome', label: 'Tome', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="260" height="220" viewBox="0 0 260 220">
      <rect x="55" y="35" width="150" height="160" rx="14" fill="rgba(0,0,0,0.45)" stroke="#daa520" stroke-width="10"/>
      <rect x="75" y="55" width="110" height="120" rx="10" fill="rgba(0,0,0,0.22)" stroke="rgba(218,165,32,0.4)" stroke-width="6"/>
      <path d="M130 72 V178" stroke="#daa520" stroke-width="8" opacity="0.9"/>
      <circle cx="130" cy="120" r="10" fill="#daa520"/>
    </svg>`) },
    { key: 'wax_seal', label: 'Wax Seal', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="260" height="260" viewBox="0 0 260 260">
      <circle cx="130" cy="130" r="110" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
      <circle cx="130" cy="130" r="78" fill="rgba(0,0,0,0.22)" stroke="rgba(218,165,32,0.35)" stroke-width="6"/>
      <text x="130" y="120" font-family="Georgia" font-size="22" text-anchor="middle" fill="#e8d5b7" opacity="0.9">THE LIBRARY</text>
      <text x="130" y="156" font-family="Georgia" font-size="18" text-anchor="middle" fill="#e8d5b7" opacity="0.75">REMEMBERS</text>
    </svg>`) },
    { key: 'chains', label: 'Chains', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="340" height="220" viewBox="0 0 340 220">
      <g fill="none" stroke="#daa520" stroke-width="10" opacity="0.9" stroke-linecap="round">
        <path d="M60 60 C95 25, 145 25, 180 60 C215 95, 215 145, 180 180 C145 215, 95 215, 60 180 C25 145, 25 95, 60 60 Z"/>
        <path d="M160 40 C195 5, 245 5, 280 40 C315 75, 315 125, 280 160 C245 195, 195 195, 160 160 C125 125, 125 75, 160 40 Z"/>
      </g>
      <path d="M140 110 H200" stroke="rgba(232,213,183,0.6)" stroke-width="8" stroke-linecap="round"/>
    </svg>`) },
    { key: 'hourglass', label: 'Hourglass', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="300" viewBox="0 0 200 300">
      <path d="M40 30 H160" stroke="#daa520" stroke-width="12" stroke-linecap="round"/>
      <path d="M40 270 H160" stroke="#daa520" stroke-width="12" stroke-linecap="round"/>
      <path d="M55 45 C70 120, 130 120, 145 45" fill="none" stroke="#daa520" stroke-width="10"/>
      <path d="M55 255 C70 180, 130 180, 145 255" fill="none" stroke="#daa520" stroke-width="10"/>
      <path d="M78 95 C92 120, 108 120, 122 95" fill="none" stroke="rgba(232,213,183,0.8)" stroke-width="8" stroke-linecap="round"/>
      <path d="M78 205 C92 180, 108 180, 122 205" fill="none" stroke="rgba(232,213,183,0.55)" stroke-width="8" stroke-linecap="round"/>
      <circle cx="100" cy="150" r="6" fill="rgba(232,213,183,0.75)"/>
    </svg>`) },
    { key: 'blindfold', label: 'Blindfold', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="360" height="140" viewBox="0 0 360 140">
      <rect x="30" y="50" width="300" height="50" rx="20" fill="rgba(0,0,0,0.55)" stroke="#daa520" stroke-width="8"/>
      <path d="M50 60 C80 20, 120 20, 150 60" fill="none" stroke="rgba(232,213,183,0.35)" stroke-width="6" stroke-linecap="round"/>
      <path d="M210 60 C240 20, 280 20, 310 60" fill="none" stroke="rgba(232,213,183,0.35)" stroke-width="6" stroke-linecap="round"/>
    </svg>`) },
    { key: 'spirit_fog', label: 'Spirit Fog', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="768" height="768" viewBox="0 0 768 768">
      <defs>
        <radialGradient id="f" cx="50%" cy="55%" r="70%">
          <stop offset="0%" stop-color="rgba(232,213,183,0.22)"/>
          <stop offset="60%" stop-color="rgba(232,213,183,0.10)"/>
          <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
        </radialGradient>
      </defs>
      <circle cx="384" cy="420" r="340" fill="url(#f)"/>
      <path d="M90 520 C180 460, 280 620, 380 560 C470 510, 560 610, 680 540" fill="none" stroke="rgba(232,213,183,0.12)" stroke-width="28" stroke-linecap="round"/>
      <path d="M120 600 C220 540, 320 700, 430 640 C520 590, 610 690, 720 620" fill="none" stroke="rgba(232,213,183,0.10)" stroke-width="24" stroke-linecap="round"/>
    </svg>`) },
    { key: 'star_map', label: 'Star Map', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="768" height="768" viewBox="0 0 768 768">
      <rect x="0" y="0" width="768" height="768" fill="rgba(0,0,0,0)"/>
      <g fill="#e8d5b7" opacity="0.22">
        <circle cx="120" cy="160" r="3"/><circle cx="180" cy="260" r="2"/><circle cx="310" cy="110" r="2"/>
        <circle cx="520" cy="220" r="3"/><circle cx="640" cy="140" r="2"/><circle cx="610" cy="340" r="2"/>
        <circle cx="420" cy="420" r="3"/><circle cx="250" cy="460" r="2"/><circle cx="140" cy="560" r="3"/>
        <circle cx="340" cy="640" r="2"/><circle cx="560" cy="610" r="3"/><circle cx="680" cy="520" r="2"/>
      </g>
      <g stroke="#daa520" opacity="0.18" stroke-width="3" fill="none">
        <path d="M120 160 L180 260 L310 110"/>
        <path d="M520 220 L640 140 L610 340"/>
        <path d="M140 560 L250 460 L420 420 L560 610 L680 520"/>
      </g>
    </svg>`) }
  ];

  function fitBaseImage(img) {
    const s = Math.min(img.width, img.height);
    const sx = (img.width - s) / 2;
    const sy = (img.height - s) / 2;
    state.baseCrop = { sx, sy, s };
  }

  function drawBase() {
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.fillRect(0, 0, W, H);
    if (!state.baseImg) return;
    const { sx, sy, s } = state.baseCrop;
    ctx.drawImage(state.baseImg, sx, sy, s, s, 0, 0, W, H);
  }

  function drawFrame() {
    if (state.frame === 'none') return;

    if (state.frame === 'gold') {
      const pad = 20;
      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.strokeStyle = '#daa520';
      ctx.lineWidth = 18;
      ctx.beginPath();
      ctx.arc(W/2, H/2, (Math.min(W,H)/2) - pad, 0, Math.PI*2);
      ctx.stroke();

      ctx.globalAlpha = 0.25;
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(W/2, H/2, (Math.min(W,H)/2) - pad - 26, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    if (state.frame === 'seal') {
      ctx.save();
      ctx.strokeStyle = '#daa520';
      ctx.globalAlpha = 0.95;
      ctx.lineWidth = 10;
      const m = 26;
      ctx.strokeRect(m, m, W - m*2, H - m*2);

      ctx.globalAlpha = 0.22;
      ctx.lineWidth = 3;
      ctx.strokeRect(m+18, m+18, W - (m+18)*2, H - (m+18)*2);

      ctx.globalAlpha = 0.9;
      ctx.lineWidth = 10;
      const c = 62;
      const drawCorner = (x,y,dx,dy) => {
        ctx.beginPath(); ctx.moveTo(x, y+dy*c); ctx.lineTo(x, y); ctx.lineTo(x+dx*c, y); ctx.stroke();
      };
      drawCorner(m, m, 1, 1);
      drawCorner(W-m, m, -1, 1);
      drawCorner(m, H-m, 1, -1);
      drawCorner(W-m, H-m, -1, -1);
      ctx.restore();
    }
  }

  function drawText() {
    const text = (textInput.value || '').trim();
    if (!text) return;

    ctx.save();
    ctx.textAlign = 'center';
    ctx.fillStyle = '#e8d5b7';
    ctx.strokeStyle = 'rgba(0,0,0,0.7)';
    ctx.lineWidth = 10;

    let fontSize = 64;
    const maxWidth = W * 0.86;
    do {
      ctx.font = `bold ${fontSize}px Georgia`;
      if (ctx.measureText(text).width <= maxWidth) break;
      fontSize -= 2;
    } while (fontSize > 28);

    const drawLine = (y) => {
      ctx.strokeText(text, W/2, y);
      ctx.fillText(text, W/2, y);
    };

    if (state.textMode === 'top' || state.textMode === 'both') drawLine(90);
    if (state.textMode === 'bottom' || state.textMode === 'both') drawLine(H - 60);

    ctx.restore();
  }

  function drawStickers() {
    for (const s of state.stickers) {
      ctx.save();
      ctx.translate(s.x, s.y);
      ctx.rotate(s.rot || 0);
      ctx.drawImage(s.img, -s.w/2, -s.h/2, s.w, s.h);

      if (s.id === state.selectedId) {
        ctx.strokeStyle = 'rgba(218,165,32,0.9)';
        ctx.lineWidth = 4;
        ctx.strokeRect(-s.w/2, -s.h/2, s.w, s.h);
      }
      ctx.restore();
    }
  }

  function render() {
    drawBase();
    drawStickers();
    drawFrame();
    drawText();
  }

  function addSticker(src, opts = {}) {
    const img = new Image();
    img.onload = () => {
      const base = Math.min(W, H);
      const defaultW = base * (opts.scale ?? 0.28);
      const w = Math.max(40, Math.min(W*0.9, defaultW));
      const h = Math.max(40, Math.min(H*0.9, w * (img.height / img.width)));
      const id = 'st_' + Math.random().toString(16).slice(2);
      const x = opts.x ?? (W/2);
      const y = opts.y ?? (H/2);
      const rot = opts.rot ?? 0;
      state.stickers.push({ img, x, y, w, h, rot, id, key: opts.key || '' });
      state.selectedId = id;
      render();
    };
    img.src = src;
  }

  // Sticker UI buttons
  STICKERS.forEach(st => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn small';
    btn.textContent = st.label;
    btn.addEventListener('click', () => addSticker(st.src, { key: st.key }));
    stickerBar.appendChild(btn);
  });

  // Presets (minimal, lore-forward)
  const PRESETS = [
    {
      label: 'The Librarian',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'gold';
        state.textMode = 'bottom';
        textInput.value = '$WanShiTong';
        // Seal + Sigil
        const seal = STICKERS.find(s => s.key === 'wax_seal');
        const sigil = STICKERS.find(s => s.key === 'sigil');
        if (seal) addSticker(seal.src, { key: seal.key, x: W*0.23, y: H*0.78, scale: 0.30 });
        if (sigil) addSticker(sigil.src, { key: sigil.key, x: W*0.78, y: H*0.78, scale: 0.24 });
        render();
      }
    },
    {
      label: 'Forbidden Knowledge',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'seal';
        state.textMode = 'both';
        textInput.value = 'THE LIBRARY REMEMBERS';
        const fog = STICKERS.find(s => s.key === 'spirit_fog');
        const starmap = STICKERS.find(s => s.key === 'star_map');
        const chains = STICKERS.find(s => s.key === 'chains');
        const scroll = STICKERS.find(s => s.key === 'scroll');
        if (starmap) addSticker(starmap.src, { key: starmap.key, x: W/2, y: H/2, scale: 0.98 });
        if (fog) addSticker(fog.src, { key: fog.key, x: W/2, y: H/2, scale: 0.98 });
        if (chains) addSticker(chains.src, { key: chains.key, x: W/2, y: H*0.78, scale: 0.62 });
        if (scroll) addSticker(scroll.src, { key: scroll.key, x: W*0.78, y: H*0.26, scale: 0.30 });
        render();
      }
    },
    {
      label: 'The Judge',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'gold';
        state.textMode = 'top';
        textInput.value = 'NO WAR IN THE LIBRARY';
        const blind = STICKERS.find(s => s.key === 'blindfold');
        const hour = STICKERS.find(s => s.key === 'hourglass');
        const seal = STICKERS.find(s => s.key === 'wax_seal');
        if (blind) addSticker(blind.src, { key: blind.key, x: W/2, y: H*0.36, scale: 0.62 });
        if (hour) addSticker(hour.src, { key: hour.key, x: W*0.82, y: H*0.60, scale: 0.30 });
        if (seal) addSticker(seal.src, { key: seal.key, x: W*0.20, y: H*0.78, scale: 0.28 });
        render();
      }
    },
    {
      label: 'The Archivist',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'seal';
        state.textMode = 'bottom';
        textInput.value = '$WanShiTong';
        const tome = STICKERS.find(s => s.key === 'tome');
        const crown = STICKERS.find(s => s.key === 'feather_crown');
        const eyes = STICKERS.find(s => s.key === 'owl_eyes');
        if (crown) addSticker(crown.src, { key: crown.key, x: W/2, y: H*0.16, scale: 0.64 });
        if (eyes) addSticker(eyes.src, { key: eyes.key, x: W/2, y: H*0.40, scale: 0.70 });
        if (tome) addSticker(tome.src, { key: tome.key, x: W*0.82, y: H*0.80, scale: 0.30 });
        render();
      }
    }
  ];

  if (presetsBar) {
    PRESETS.forEach(p => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn small';
      btn.textContent = p.label;
      btn.addEventListener('click', p.apply);
      presetsBar.appendChild(btn);
    });
  }

  // Upload
  upload.addEventListener('change', e => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => {
      state.baseImg = img;
      fitBaseImage(img);
      state.stickers = [];
      state.selectedId = null;
      render();
    };
    img.src = URL.createObjectURL(file);
  });

  // Text mode buttons
  document.querySelectorAll('[data-textstyle]').forEach(btn => {
    btn.addEventListener('click', () => { state.textMode = btn.getAttribute('data-textstyle'); render(); });
  });

  // Frame buttons
  document.querySelectorAll('[data-frame]').forEach(btn => {
    btn.addEventListener('click', () => { state.frame = btn.getAttribute('data-frame'); render(); });
  });

  clearTextBtn.addEventListener('click', () => { textInput.value = ''; render(); });
  textInput.addEventListener('input', () => render());

  // Drag/select
  let dragging = false;
  let dragOffset = {x:0,y:0};

  function hitTest(x,y) {
    for (let i = state.stickers.length - 1; i >= 0; i--) {
      const s = state.stickers[i];
      // approximate AABB (ignoring rotation)
      if (x >= s.x - s.w/2 && x <= s.x + s.w/2 && y >= s.y - s.h/2 && y <= s.y + s.h/2) return s;
    }
    return null;
  }

  function getPos(ev) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width;
    const scaleY = H / rect.height;
    return { x: (ev.clientX - rect.left) * scaleX, y: (ev.clientY - rect.top) * scaleY };
  }

  canvas.addEventListener('mousedown', ev => {
    const p = getPos(ev);
    const s = hitTest(p.x,p.y);
    if (!s) { state.selectedId = null; render(); return; }
    state.selectedId = s.id;
    // bring to top
    state.stickers = state.stickers.filter(x => x.id !== s.id).concat([s]);
    dragging = true;
    dragOffset = { x: p.x - s.x, y: p.y - s.y };
    render();
  });

  window.addEventListener('mousemove', ev => {
    if (!dragging) return;
    const p = getPos(ev);
    const s = state.stickers.find(x => x.id === state.selectedId);
    if (!s) return;
    s.x = p.x - dragOffset.x;
    s.y = p.y - dragOffset.y;
    render();
  });

  window.addEventListener('mouseup', () => dragging = false);

  // Wheel to resize selected sticker
  canvas.addEventListener('wheel', ev => {
    const s = state.stickers.find(x => x.id === state.selectedId);
    if (!s) return;
    ev.preventDefault();
    const delta = Math.sign(ev.deltaY);
    const factor = delta > 0 ? 0.94 : 1.06;
    s.w = Math.max(40, Math.min(W*0.95, s.w * factor));
    s.h = Math.max(40, Math.min(H*0.95, s.h * factor));
    render();
  }, { passive: false });

  // Delete key removes selected sticker
  window.addEventListener('keydown', ev => {
    if (ev.key !== 'Delete' && ev.key !== 'Backspace') return;
    if (!state.selectedId) return;
    state.stickers = state.stickers.filter(s => s.id !== state.selectedId);
    state.selectedId = null;
    render();
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    state.baseImg = null;
    state.stickers = [];
    state.selectedId = null;
    state.textMode = 'bottom';
    state.frame = 'gold';
    textInput.value = '$WanShiTong';
    upload.value = '';
    render();
  });

  // Download
  dlBtn.addEventListener('click', () => {
    render();
    const a = document.createElement('a');
    a.download = 'WanShiTong-PFP.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  // First render
  render();
})();
</script>

  <script type="module">
    // ===== 3D Model Viewer (Three.js) =====
    // Expected files (change as needed):
    // /models/wan_shi_tong.obj
    // /models/wan_shi_tong.mtl
    // (textures referenced by the MTL should also live in /models/)
    const MODEL_PATHS = {
      obj: '/models/wan_shi_tong.obj',
      mtl: '/models/wan_shi_tong.mtl'
    };

    const statusEl = document.getElementById('modelStatus');
    const canvas = document.getElementById('modelCanvas');

    function showStatus(msg) {
      if (!statusEl) return;
      statusEl.style.display = 'block';
      statusEl.textContent = msg;
    }

    try {
      const THREE = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js');
      const { OrbitControls } = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js');
      const { MTLLoader } = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/MTLLoader.js');
      const { OBJLoader } = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/OBJLoader.js');

      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

      const scene = new THREE.Scene();
      scene.background = null;

      const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
      camera.position.set(0, 1.2, 3.2);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.target.set(0, 1.0, 0);

      // Lights
      const hemi = new THREE.HemisphereLight(0xffffff, 0x111111, 0.9);
      scene.add(hemi);
      const key = new THREE.DirectionalLight(0xffffff, 1.0);
      key.position.set(2, 4, 3);
      scene.add(key);
      const fill = new THREE.DirectionalLight(0xffffff, 0.45);
      fill.position.set(-2, 2, -3);
      scene.add(fill);

      function resize() {
        const wrap = canvas.parentElement;
        if (!wrap) return;
        const w = wrap.clientWidth;
        const h = wrap.clientHeight;
        renderer.setSize(w, h, false);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }
      window.addEventListener('resize', resize);
      resize();

      showStatus('Summoning the Archivist...');

      const mtlLoader = new MTLLoader();
      mtlLoader.setPath('/models/');
      mtlLoader.load(
        MODEL_PATHS.mtl.replace('/models/', ''),
        (materials) => {
          materials.preload();
          const objLoader = new OBJLoader();
          objLoader.setMaterials(materials);
          objLoader.setPath('/models/');
          objLoader.load(
            MODEL_PATHS.obj.replace('/models/', ''),
            (object) => {
              // Normalize size and center
              const box = new THREE.Box3().setFromObject(object);
              const size = new THREE.Vector3();
              box.getSize(size);
              const center = new THREE.Vector3();
              box.getCenter(center);

              object.position.sub(center);
              const maxDim = Math.max(size.x, size.y, size.z) || 1;
              const scale = 2.0 / maxDim;
              object.scale.setScalar(scale);

              scene.add(object);
              statusEl.style.display = 'none';
            },
            (xhr) => {
              if (xhr.total) {
                const pct = Math.round((xhr.loaded / xhr.total) * 100);
                showStatus(`Loading model‚Ä¶ ${pct}%`);
              }
            },
            (err) => {
              console.error(err);
              showStatus('Model not found. Add files to /models/ and redeploy.');
            }
          );
        },
        undefined,
        (err) => {
          console.error(err);
          showStatus('Materials not found. Add /models/wan_shi_tong.mtl and textures, then redeploy.');
        }
      );

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    } catch (e) {
      console.error(e);
      showStatus('3D viewer failed to load. If you are blocking CDNs, allow jsdelivr.');
    }
  </script>

</body>
</html>
