<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wan Shi Tong's Library ‚Äì $WanShiTong</title>
  <meta name="description" content="$WanShiTong - He Who Knows Ten Thousand Things. The wisest meme coin on Solana. Join the library of knowledge seekers.">
  <meta property="og:title" content="Wan Shi Tong's Library - $WanShiTong">
  <meta property="og:description" content="He Who Knows Ten Thousand Things now guards your bags on Solana">
  <meta property="og:image" content="https://wanshitong.xyz/wan-shi-tong.png">
  <meta name="twitter:card" content="summary_large_image">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #1a0a0a 0%, #3d2314 50%, #1a0a0a 100%);
      color: #e8d5b7;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .stars {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .star {
      position: absolute;
      background: #fff;
      border-radius: 50%;
      animation: twinkle 3s infinite;
      transition: transform 0.1s ease-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.25; }
      50% { opacity: 0.9; }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    header {
      text-align: center;
      padding: 60px 20px 34px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
      position: relative;
      z-index: 1;
      animation: fadeInUp 0.8s ease-out;
    }

    .owl-icon {
      width: 200px;
      height: 200px;
      margin: 0 auto 18px;
      border-radius: 50%;
      overflow: hidden;
      border: 4px solid #daa520;
      box-shadow: 0 0 30px rgba(218, 165, 32, 0.5);
      animation: float 3s ease-in-out infinite;
      position: relative;
      transition: transform 0.2s ease-out, box-shadow 0.3s ease;
      cursor: pointer;
      will-change: transform;
    }

    .owl-icon:hover {
      box-shadow: 0 0 50px rgba(218, 165, 32, 0.8);
    }

    .owl-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center top;
      display: block;
    }

    h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      letter-spacing: 3px;
      transition: text-shadow 0.3s ease;
    }

    h1:hover {
      text-shadow: 
        0 0 10px #daa520,
        0 0 20px #daa520,
        0 0 30px #daa520,
        2px 2px 4px rgba(0,0,0,0.8);
    }

    .subtitle {
      font-style: italic;
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 18px;
    }

    .warning {
      background: rgba(139, 0, 0, 0.3);
      border: 2px solid #8b0000;
      padding: 15px;
      max-width: 780px;
      margin: 14px auto 0;
      border-radius: 7px;
      font-size: 0.95em;
    }

    .price-ticker {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.85);
      border: 2px solid #8b6914;
      border-radius: 12px;
      padding: 16px 20px;
      backdrop-filter: blur(10px);
      z-index: 100;
      min-width: 240px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      transition: transform 0.3s ease;
    }

    .price-ticker:hover {
      transform: translateY(-4px);
      border-color: #daa520;
    }

    .ticker-title {
      font-size: 0.85em;
      opacity: 0.8;
      margin-bottom: 8px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .ticker-price {
      font-size: 1.8em;
      font-weight: bold;
      color: #daa520;
      margin-bottom: 6px;
      font-family: 'Courier New', monospace;
    }

    .ticker-change {
      font-size: 0.95em;
      font-family: 'Courier New', monospace;
    }

    .ticker-change.positive { color: #00ff88; }
    .ticker-change.negative { color: #ff4444; }

    .ticker-link {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(218,165,32,0.25);
      font-size: 0.85em;
      opacity: 0.8;
    }

    .ticker-link a {
      color: #daa520;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .ticker-link a:hover { opacity: 1; }

    .floating-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .sand-particle {
      position: absolute;
      background: rgba(194,178,128,0.4);
      border-radius: 50%;
      animation: float-particle linear infinite;
    }

    @keyframes float-particle {
      0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.6; }
      100% { transform: translateY(-100vh) translateX(var(--drift)) rotate(360deg); opacity: 0; }
    }

    .spirit-wisp {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(138,43,226,0.5) 0%, rgba(138,43,226,0) 70%);
      animation: drift-wisp linear infinite;
      filter: blur(8px);
    }

    @keyframes drift-wisp {
      0% { transform: translate(0, 0) scale(1); opacity: 0; }
      10% { opacity: 0.7; }
      50% { transform: translate(var(--drift-x), var(--drift-y)) scale(1.5); }
      90% { opacity: 0.7; }
      100% { transform: translate(calc(var(--drift-x) * 2), calc(var(--drift-y) * 2)) scale(1); opacity: 0; }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 34px 20px 50px;
      position: relative;
      z-index: 1;
    }

    .lore-trigger { position: relative; }
    .lore-popover {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: calc(100% + 14px);
      width: min(560px, calc(100vw - 40px));
      background: rgba(0,0,0,0.78);
      border: 2px solid #8b6914;
      border-radius: 10px;
      padding: 18px 18px 14px;
      box-shadow: 0 12px 35px rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 20;
    }
    .lore-title {
      color: #daa520;
      font-weight: bold;
      letter-spacing: 1px;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-size: 0.95em;
    }
    .lore-text {
      line-height: 1.6;
      font-size: 1.05em;
      color: #e8d5b7;
      min-height: 64px;
      white-space: pre-wrap;
    }
    .lore-hint {
      margin-top: 10px;
      opacity: 0.82;
      font-size: 0.9em;
      color: #e8d5b7;
      border-top: 1px solid rgba(218,165,32,0.25);
      padding-top: 10px;
    }
    .lore-trigger:hover .lore-popover,
    .lore-trigger:focus-within .lore-popover {
      opacity: 1;
      pointer-events: auto;
    }
    .lore-popover::before {
      content: "";
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 14px;
      height: 14px;
      background: rgba(0,0,0,0.78);
      border-left: 2px solid #8b6914;
      border-top: 2px solid #8b6914;
    }

    .token-hero { 
      margin: 0 0 26px;
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }
    .token-card {
      background: rgba(61, 35, 20, 0.6);
      border: 2px solid #8b6914;
      border-radius: 12px;
      padding: 28px;
      backdrop-filter: blur(6px);
    }
    .token-row {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .token-kicker {
      opacity: 0.85;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 0.9em;
      margin-bottom: 6px;
    }
    .token-name {
      font-size: 2.6em;
      color: #daa520;
      letter-spacing: 3px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      transition: text-shadow 0.3s ease;
    }
    .token-name:hover {
      text-shadow: 
        0 0 10px #daa520,
        0 0 20px #daa520,
        0 0 30px #daa520,
        2px 2px 4px rgba(0,0,0,0.8);
    }
    .token-tagline { opacity: 0.95; margin-top: 6px; max-width: 70ch; }
    .token-actions { display: flex; gap: 12px; flex-wrap: wrap; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #8b6914;
      background: rgba(0,0,0,0.35);
      color: #e8d5b7;
      text-decoration: none;
      font-weight: bold;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      cursor: pointer;
      font-family: 'Georgia', serif;
    }
    .btn:hover { transform: translateY(-2px); border-color: #daa520; background: rgba(0,0,0,0.5); }
    .btn.primary { background: #8b6914; border-color: #8b6914; }
    .btn.primary:hover { background: #daa520; border-color: #daa520; }
    .btn.small { padding: 10px 14px; font-size: 0.95em; }

    .ca-box {
      margin-top: 18px;
      background: rgba(0,0,0,0.35);
      border: 2px solid rgba(218,165,32,0.35);
      border-radius: 10px;
      padding: 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px 12px;
      align-items: center;
    }
    .ca-label { opacity: 0.9; color: #daa520; font-weight: bold; }
    .ca-value {
      grid-column: 1 / -1;
      font-family: 'Courier New', monospace;
      font-size: 0.95em;
      word-break: break-all;
      padding: 10px;
      border-radius: 8px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(218,165,32,0.25);
    }
    .copy-status { opacity: 0.9; font-size: 0.9em; justify-self: end; }

    .share-row {
      margin-top: 18px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .token-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 14px;
      margin-top: 18px;
    }
    .stat {
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(218,165,32,0.22);
      border-radius: 10px;
      padding: 14px;
    }
    .stat-label { opacity: 0.85; font-size: 0.95em; }
    .stat-value { color: #daa520; font-weight: bold; margin-top: 6px; font-size: 1.05em; }

    .links-row {
      margin-top: 18px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      border: 2px solid rgba(218,165,32,0.25);
      background: rgba(0,0,0,0.3);
      color: #e8d5b7;
      text-decoration: none;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .pill:hover { transform: translateY(-2px); border-color: #daa520; }

    .disclaimer {
      margin-top: 18px;
      opacity: 0.85;
      font-size: 0.95em;
      border-top: 1px solid rgba(218,165,32,0.22);
      padding-top: 14px;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 22px;
      margin: 18px 0 40px;
    }
    .panel {
      background: rgba(61, 35, 20, 0.55);
      border: 2px solid #8b6914;
      border-radius: 12px;
      padding: 22px;
      backdrop-filter: blur(5px);
      animation: fadeInUp 0.6s ease-out both;
    }
    .panel:nth-child(1) { animation-delay: 0.3s; }
    .panel:nth-child(2) { animation-delay: 0.4s; }
    .panel:nth-child(3) { animation-delay: 0.5s; }
    .panel h3 { color: #daa520; margin-bottom: 12px; font-size: 1.5em; }
    .clean-list { list-style: none; padding-left: 0; }
    .clean-list li {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(218,165,32,0.18);
    }
    .clean-list li:last-child { border-bottom: none; }
    .steps { margin-left: 18px; }
    .steps li { margin: 10px 0; line-height: 1.55; }
    .roadmap { display: grid; gap: 12px; }
    .milestone {
      padding: 12px;
      border-radius: 10px;
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(218,165,32,0.22);
      line-height: 1.55;
    }
    .milestone span {
      display: inline-block;
      margin-right: 10px;
      color: #daa520;
      font-weight: bold;
    }
    .muted { opacity: 0.9; line-height: 1.6; }

    .knowledge-sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 50px;
      align-items: stretch;
      justify-items: stretch;
    }

    .section {
      background: rgba(61, 35, 20, 0.6);
      border: 2px solid #8b6914;
      border-radius: 10px;
      padding: 30px;
      transition: all 0.3s ease;
      cursor: pointer;
      backdrop-filter: blur(5px);
      min-height: 270px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: fadeInUp 0.6s ease-out both;
    }

    .section:nth-child(1) { animation-delay: 0.6s; }
    .section:nth-child(2) { animation-delay: 0.7s; }
    .section:nth-child(3) { animation-delay: 0.8s; }

    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(139, 105, 20, 0.4);
      border-color: #daa520;
    }

    .section h2 {
      color: #daa520;
      margin-bottom: 8px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-icon { font-size: 1.3em; }
    .section-icon svg{
      width: 22px;
      height: 22px;
      stroke: #daa520;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0.9;
      transition: all 0.2s ease;
    }
    .section:hover .section-icon svg{
      opacity: 1;
      transform: translateY(-1px);
    }
    .section p { line-height: 1.6; opacity: 0.9; margin-top: 0; }

    .quote-section {
      background: rgba(0, 0, 0, 0.5);
      border-left: 4px solid #daa520;
      padding: 30px;
      margin: 50px 0;
      border-radius: 5px;
      animation: fadeInUp 0.6s ease-out 0.9s both;
    }

    .quote {
      font-size: 1.3em;
      font-style: italic;
      text-align: center;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .quote-author {
      text-align: right;
      color: #daa520;
      font-weight: bold;
    }

    .knowledge-form {
      background: rgba(61, 35, 20, 0.6);
      border: 2px solid #8b6914;
      border-radius: 10px;
      padding: 40px;
      max-width: 720px;
      margin: 50px auto 30px;
      animation: fadeInUp 0.6s ease-out 1s both;
    }

    .knowledge-form h3 {
      color: #daa520;
      margin-bottom: 14px;
      font-size: 1.8em;
      text-align: center;
    }

    .form-group { margin-bottom: 20px; }
    label {
      display: block;
      margin-bottom: 8px;
      color: #daa520;
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid #8b6914;
      border-radius: 5px;
      color: #e8d5b7;
      font-family: 'Georgia', serif;
      font-size: 1em;
    }

    input:focus, textarea:focus { outline: none; border-color: #daa520; }
    textarea { resize: vertical; min-height: 120px; }

    button {
      background: #8b6914;
      color: #e8d5b7;
      border: none;
      padding: 15px 40px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Georgia', serif;
      width: 100%;
      font-weight: bold;
    }

    button:hover {
      background: #daa520;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(232, 213, 183, 0.3);
      border-top-color: #e8d5b7;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .submission-message {
      background: rgba(0, 0, 0, 0.55);
      border: 2px solid rgba(218, 165, 32, 0.35);
      padding: 15px;
      border-radius: 8px;
      margin-top: 18px;
      text-align: left;
      display: none;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    /* PFP Generator specific styles */
    .pfp-controls { display: grid; gap: 16px; }
    .control-group { display: flex; flex-direction: column; gap: 8px; }
    .control-group label { font-size: 0.95em; margin-bottom: 4px; }
    .button-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .preset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }

    .preset-btn {
      aspect-ratio: 1;
      background: rgba(0,0,0,0.4);
      border: 2px solid #8b6914;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.85em;
      color: #e8d5b7;
      text-align: center;
    }

    .preset-btn:hover { border-color: #daa520; transform: scale(1.05); }
    .preset-icon { font-size: 1.5em; }

    input[type="range"] {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.4);
      border: 1px solid #8b6914;
      border-radius: 3px;
      outline: none;
      padding: 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      background: #daa520;
      border-radius: 50%;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #daa520;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .undo-redo { display: flex; gap: 8px; }

    footer {
      text-align: center;
      padding: 40px 20px;
      opacity: 0.7;
      font-size: 0.9em;
      z-index: 1;
      position: relative;
    }

    @media (max-width: 768px) {
      .token-actions { width: 100%; }
      .token-actions .btn { flex: 1; min-width: 140px; }
      .ca-box { grid-template-columns: 1fr; }
      .section { min-height: auto; }
      .price-ticker { bottom: 10px; right: 10px; min-width: 200px; padding: 12px 16px; }
      .ticker-price { font-size: 1.5em; }
      #pfpGen > div > div > div:first-child { grid-template-columns: 1fr !important; }
    }

    @media (max-width: 520px) {
      h1 { font-size: 2.2em; }
      .token-name { font-size: 2.1em; }
      .token-card { padding: 22px; }
    }
  
/* ===== Added: Spirit Runner + Meme Library + Spirit Sigil (no 3D) ===== */
#wstRunnerSection{margin-top:28px;}
#wstRunnerCard{border:1px solid rgba(218,165,32,0.35);border-radius:16px;background:rgba(0,0,0,0.35);padding:16px;box-shadow:0 0 28px rgba(218,165,32,0.10);}
#wstRunnerHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
#wstRunnerHeader h3{margin:0;color:#daa520;font-size:26px;letter-spacing:0.04em;}
#wstRunnerHeader p{margin:6px 0 0;color:rgba(232,227,214,0.8);}
#wstRunnerHud{display:flex;gap:10px;flex-wrap:wrap;}
.wstPill{border:1px solid rgba(218,165,32,0.35);border-radius:999px;padding:7px 11px;background:rgba(0,0,0,0.35);font-size:13px;color:rgba(232,227,214,0.9);}
#wstRunnerCanvas{width:100%;height:auto;display:block;border-radius:14px;border:1px solid rgba(218,165,32,0.25);background:linear-gradient(180deg, rgba(8,10,12,.92), rgba(0,0,0,.55));margin-top:12px;}
#wstRunnerControls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
#wstRunnerControls .btn{width:auto;min-width:160px}
#wstRunnerLb{margin-top:14px;border-top:1px solid rgba(218,165,32,0.18);padding-top:14px;}
#wstRunnerLb h4{margin:0 0 8px;color:#daa520;font-size:18px;}
#wstRunnerLb .muted{opacity:.85;font-size:13px;}
#wstRunnerLbList{margin:10px 0 0;padding:0;list-style:none;}
#wstRunnerLbList li{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid rgba(218,165,32,0.18);border-radius:12px;background:rgba(0,0,0,0.25);margin-bottom:8px;font-size:14px;}
@media (max-width:700px){ #wstRunnerHeader h3{font-size:22px;} .wstPill{font-size:12px;} }

#wstMemeLibrary{margin-top:28px;}
#wstMemeFrame{width:100%;max-width:980px;aspect-ratio:16/9;margin:0 auto;border-radius:14px;overflow:hidden;border:1px solid rgba(218,165,32,0.25);background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;}
#wstMemeImg{max-width:100%;max-height:100%;object-fit:contain;display:block;}
#wstMemeCaption{margin:14px 0 0;border:1px solid rgba(218,165,32,0.25);border-radius:12px;background:rgba(0,0,0,0.25);padding:12px;color:rgba(232,227,214,0.9);}
#wstMemeBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px;}
#wstMemeBtns .btn{min-width:160px;width:auto}

#wstSpiritBottom{margin-top:28px;}
#wstSpiritCard{border:1px solid rgba(218,165,32,0.35);border-radius:16px;background:rgba(0,0,0,0.35);padding:16px;box-shadow:0 0 28px rgba(218,165,32,0.10);}
#wstSpiritImgWrap{position:relative;max-width:420px;margin:12px auto 0;border-radius:14px;overflow:hidden;border:1px solid rgba(218,165,32,0.25);background:rgba(0,0,0,0.35);}
#wstSpiritImgWrap img{display:block;width:100%;height:auto;}
.wstLaser{position:absolute;width:44px;height:44px;left:50%;top:36%;transform:translate(-50%,-50%);opacity:0;pointer-events:none;}
.wstLaser::before{content:"";position:absolute;inset:0;border-radius:50%;
  background:radial-gradient(circle, rgba(255,255,255,0.95) 0%, rgba(255,80,80,0.95) 28%, rgba(255,0,0,0.25) 60%, rgba(255,0,0,0) 72%);
  filter:blur(0.2px);
}
#wstLaserL{margin-left:-64px;}
#wstLaserR{margin-left:64px;}
#wstSpiritImgWrap.awakened .wstLaser{opacity:1;animation:wstPulse 1.2s ease-in-out infinite;}
@keyframes wstPulse{0%,100%{transform:translate(-50%,-50%) scale(0.95);}50%{transform:translate(-50%,-50%) scale(1.08);}}
#wstSpiritImgWrap.awakened::after{
  content:"";
  position:absolute;
  left:0;right:0;top:36%;
  height:3px;
  background:linear-gradient(90deg, rgba(255,0,0,0) 0%, rgba(255,80,80,0.85) 20%, rgba(255,255,255,0.95) 50%, rgba(255,80,80,0.85) 80%, rgba(255,0,0,0) 100%);
  filter:blur(0.6px);
  opacity:0.9;
  animation:wstSweep 1.0s ease-in-out infinite;
}
@keyframes wstSweep{0%,100%{opacity:0.55;}50%{opacity:0.95;}}

</style>
</head>

<body>
  <div class="stars" id="stars"></div>
  <div class="floating-particles" id="floatingParticles"></div>

  <div class="price-ticker" id="priceTicker">
    <div class="ticker-title">$WanShiTong</div>
    <div class="ticker-price" id="tickerPrice">Loading...</div>
    <div class="ticker-change" id="tickerChange">--</div>
    <div class="ticker-link">
      <a href="https://dexscreener.com/solana/gb1dccxamrtdcw1zhhd6nu3mrdxalzdgyld8qfcr2mwn" target="_blank" rel="noopener noreferrer">View Chart ‚Üí</a>
    </div>
  </div>

  <header>
    <div class="owl-icon lore-trigger" id="loreTrigger" tabindex="0">
      <img src="wan-shi-tong.png" alt="Wan Shi Tong" />
      <div class="lore-popover" id="lorePopover" aria-hidden="true">
        <div class="lore-title">The Knowledge Spirit Speaks</div>
        <div class="lore-text" id="loreText"></div>
        <div class="lore-hint">Hover to hear the ancient wisdom. Click for more.</div>
      </div>
    </div>

    <h1>WAN SHI TONG</h1>
    <p class="subtitle">He Who Knows Ten Thousand Things</p>
    <div class="warning">‚ö†Ô∏è Those who seek knowledge for destructive purposes will be cast out into the desert</div>
  </header>

  <div class="container">

    <section class="token-hero">
      <div class="token-card">
        <div class="token-row">
          <div>
            <div class="token-kicker">The Library Opens</div>
            <div class="token-name">$WanShiTong</div>
            <div class="token-tagline">The ancient Knowledge Spirit who guards the greatest library in existence. Once buried beneath the Si Wong Desert, now protecting your portfolio with ten thousand years of wisdom.</div>
          </div>

          <div class="token-actions">
            <a class="btn primary" href="https://jup.ag/swap/SOL-DzmMSKtWmc2vhDxEcD5EH5Qr1MZNYJYZ8uE3UHaxpump" target="_blank" rel="noopener noreferrer">Buy on Jupiter</a>
            <a class="btn" href="https://dexscreener.com/solana/gb1dccxamrtdcw1zhhd6nu3mrdxalzdgyld8qfcr2mwn" target="_blank" rel="noopener noreferrer">View Chart</a>
          </div>
        </div>

        <div class="ca-box">
          <div class="ca-label">Contract Address</div>
          <div class="ca-value" id="caValue">DzmMSKtWmc2vhDxEcD5EH5Qr1MZNYJYZ8uE3UHaxpump</div>
          <button class="btn small" type="button" id="copyCa">Copy</button>
          <span class="copy-status" id="copyStatus" aria-live="polite"></span>
        </div>

        <div class="share-row">
          <button class="btn small" type="button" id="shareTwitter">Share on ùïè</button>
          <button class="btn small" type="button" id="copyLink">Copy Link</button>
        </div>

        <div class="token-stats">
          <div class="stat">
            <div class="stat-label">Chain</div>
            <div class="stat-value">Solana</div>
          </div>
          <div class="stat">
            <div class="stat-label">Supply</div>
            <div class="stat-value">1,000,000,000</div>
          </div>
          <div class="stat">
            <div class="stat-label">Tax</div>
            <div class="stat-value">0/0</div>
          </div>
          <div class="stat">
            <div class="stat-label">LP</div>
            <div class="stat-value">Burned / Locked</div>
          </div>
        </div>

        <div class="links-row">
          <a class="pill" href="https://x.com/i/communities/2002918673451831748" target="_blank" rel="noopener noreferrer">ùïè / Community</a>
          <a class="pill" href="https://dexscreener.com/solana/gb1dccxamrtdcw1zhhd6nu3mrdxalzdgyld8qfcr2mwn" target="_blank" rel="noopener noreferrer">Dexscreener</a>
        </div>

        <div class="disclaimer">
          <strong>Wan Shi Tong warns:</strong> I do not help those who seek knowledge for 
<section class="token-grid" id="wstRunnerSection">
  <div class="token-card" id="wstRunnerCard">
    <div id="wstRunnerHeader">
      <div>
        <h3>Wan Shi Tong: Spirit Runner</h3>
        <p class="muted">Emoji owl. Jump the flames. Press <b>X</b> to cast a whirlwind that clears nearby fire.</p>
      </div>
      <div id="wstRunnerHud">
        <div class="wstPill">Score: <span id="wstScore">0</span></div>
        <div class="wstPill">Best: <span id="wstBest">0</span></div>
        <div class="wstPill">Whirlwind: <span id="wstWhirl">Ready</span></div>
      </div>
    </div>

    <canvas id="wstRunnerCanvas" width="960" height="260"></canvas>

    <div id="wstRunnerControls">
      <button class="btn" id="wstStartBtn" type="button">Start</button>
      <button class="btn" id="wstRestartBtn" type="button">Restart (R)</button>
      <button class="btn" id="wstSubmitBtn" type="button">Submit Score</button>
      <button class="btn" id="wstShareBtn" type="button">Share on X</button>
    </div>

    <p class="muted" style="text-align:center;margin:10px 0 0;">Controls: ‚Üê/‚Üí move, Space jump, X whirlwind, R restart.</p>

    <div id="wstRunnerLb">
      <h4>Library Leaderboard (Local)</h4>
      <div class="muted">Stored in your browser (no backend).</div>
      <ul id="wstRunnerLbList"></ul>
    </div>
  </div>
</section>

<section class="token-grid" id="wstMemeLibrary">
  <div class="token-card">
    <h3>The Meme Library (Forbidden Pages)</h3>
    <p class="muted" style="text-align:center;margin-top:6px;">No predictions. Only relics, receipts, and forbidden pages.</p>

    <div id="wstMemeFrame">
      <img id="wstMemeImg" alt="Forbidden Page" src="memes/page-001.jpg" loading="lazy">
    </div>

    <div id="wstMemeCaption">Page 001 ‚Äî The first forbidden page is always the loudest.</div>

    <div id="wstMemeBtns">
      <button class="btn" id="wstPrevBtn" type="button">Prev</button>
      <button class="btn" id="wstRandBtn" type="button">Random Page</button>
      <button class="btn" id="wstNextBtn" type="button">Next</button>
      <button class="btn" id="wstCopyBtn" type="button">Copy Caption</button>
      <button class="btn" id="wstShareMemeBtn" type="button">Share on X</button>
    </div>
  </div>
</section>

<section class="token-grid" id="wstSpiritBottom">
  <div class="token-card" id="wstSpiritCard">
    <h3>Spirit World</h3>
    <p class="muted" style="text-align:center;margin-top:6px;">Awaken the Librarian. No 3D. Just the stare.</p>

    <div id="wstSpiritImgWrap">
      <img src="wan-shi-tong.png" alt="Wan Shi Tong">
      <div class="wstLaser" id="wstLaserL"></div>
      <div class="wstLaser" id="wstLaserR"></div>
    </div>

    <div style="display:flex;justify-content:center;margin-top:14px;">
      <button class="btn" id="wstAwakenBtn" type="button">Awaken</button>
    </div>
  </div>
</section>

war or personal gain. The library exists for those who truly wish to learn. Enter at your own discretion.
        </div>
      </div>
    </section>

    <section class="token-grid">
      <div class="panel">
        <h3>Tokenomics</h3>
        <ul class="clean-list">
          <li><span>Supply:</span> <strong>1B</strong></li>
          <li><span>Liquidity:</span> <strong>Fair launch</strong></li>
          <li><span>Taxes:</span> <strong>0%</strong></li>
          <li><span>Allocation:</span> <strong>100% community</strong></li>
        </ul>
        <p class="muted">No utility except wisdom, memes, and the collective knowledge of ten thousand things. The only forbidden act: bringing war to the library.</p>
      </div>

      <div class="panel">
        <h3>How to Buy</h3>
        <ol class="steps">
          <li>Get SOL in your wallet (Phantom, Backpack).</li>
          <li>Open Jupiter and paste the Contract Address.</li>
          <li>Swap SOL ‚Üí <strong>$WanShiTong</strong>.</li>
          <li>Contribute knowledge. Share lore. Guard the archives.</li>
        </ol>
      </div>

      <div class="panel">
        <h3>Roadmap</h3>
        <div class="roadmap">
          <div class="milestone"><span>Phase I</span> The Library Opens (launch, community building, initial lore drops)</div>
          <div class="milestone"><span>Phase II</span> Knowledge Seekers Gather (raids, collaborations, expanded archives)</div>
          <div class="milestone"><span>Phase III</span> Ten Thousand Things (ongoing lore, community governance, eternal wisdom)</div>
        </div>
      </div>
    </section>

    <div class="knowledge-sections">
      <div class="section">
        <h2><span class="section-icon">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <circle cx="12" cy="12" r="9"/>
  <path d="M8 10h8M8 13h8M8 16h5"/>
</svg>
</span> The Library's Guardian</h2>
        <p>Wan Shi Tong is an ancient knowledge spirit who built the greatest library in the world, hidden beneath the Si Wong Desert. For millennia, he collected knowledge from every corner of existence, demanding payment in unique information from all who enter. His towering form and countless eyes see through deception‚Äîhe knows when mortals seek knowledge for war.</p>
      </div>

      <div class="section">
        <h2><span class="section-icon">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <circle cx="17" cy="7" r="1.5"/>
  <path d="M12 3a9 9 0 1 0 0 18"/>
</svg>
</span> Betrayal & Judgment</h2>
        <p>When Team Avatar sought planetary knowledge to defeat the Fire Nation, Wan Shi Tong saw through their intentions. Furious at being used as a weapon, he dragged his entire library into the Spirit World, declaring that humans could no longer be trusted. His judgment was absolute‚Äîthose who misuse knowledge face his wrath.</p>
      </div>

      <div class="section">
        <h2><span class="section-icon">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <path d="M4 12a8 8 0 0 0 16 0"/>
  <path d="M12 4v3"/>
</svg>
</span> Spirit World Eternal</h2>
        <p>The library now exists beyond physical reach, in the Spirit World where time flows differently. Wan Shi Tong remains vigilant, aided by his knowledge seekers‚Äîfox spirits who once roamed the mortal world gathering information. His collection spans ten thousand things, from ancient scrolls to cosmic secrets, forever guarded by the one who knows all.</p>
      </div>
    </div>

    <div class="quote-section">
      <p class="quote">"You think you are the first person to believe their war was justified? Countless others before you have come here seeking weapons, weaknesses, battle strategies!"</p>
      <p class="quote-author">‚Äî Wan Shi Tong, to Professor Zei</p>
    </div>

    




</div>

  <footer>
    <p>The Library exists beyond the physical realm, deep in the Spirit World</p>
    <p>Guarded eternally by Wan Shi Tong and his Knowledge Seekers</p>
    <p style="margin-top: 10px; opacity: 0.6;">

  <script>
    // ===== Floating Particles (Sand & Spirit Wisps) =====
    const particlesContainer = document.getElementById('floatingParticles');
    
    function createSandParticle() {
      const particle = document.createElement('div');
      particle.className = 'sand-particle';
      const size = Math.random() * 3 + 1;
      particle.style.width = size + 'px';
      particle.style.height = size + 'px';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.bottom = '-10px';
      particle.style.setProperty('--drift', (Math.random() - 0.5) * 100 + 'px');
      particle.style.animationDuration = (Math.random() * 15 + 20) + 's';
      particle.style.animationDelay = Math.random() * 5 + 's';
      particlesContainer.appendChild(particle);
      setTimeout(() => particle.remove(), 30000);
    }
    
    function createSpiritWisp() {
      const wisp = document.createElement('div');
      wisp.className = 'spirit-wisp';
      wisp.style.left = Math.random() * 100 + '%';
      wisp.style.top = Math.random() * 100 + '%';
      wisp.style.setProperty('--drift-x', (Math.random() - 0.5) * 300 + 'px');
      wisp.style.setProperty('--drift-y', (Math.random() - 0.5) * 300 + 'px');
      wisp.style.animationDuration = (Math.random() * 8 + 6) + 's';
      wisp.style.animationDelay = Math.random() * 3 + 's';
      particlesContainer.appendChild(wisp);
      setTimeout(() => wisp.remove(), 20000);
    }
    
    setInterval(createSandParticle, 2000);
    setInterval(createSpiritWisp, 5000);
    for(let i = 0; i < 8; i++) createSandParticle();
    for(let i = 0; i < 3; i++) createSpiritWisp();

    // ===== Live Price Ticker =====
    async function updatePrice() {
      try {
        const response = await fetch('https://api.dexscreener.com/latest/dex/pairs/solana/gb1dccxamrtdcw1zhhd6nu3mrdxalzdgyld8qfcr2mwn');
        const data = await response.json();
        const pair = (data && data.pairs && data.pairs[0]) ? data.pairs[0] : data.pair;

        if (pair && pair.priceUsd) {
          const price = parseFloat(pair.priceUsd);
          const change24h = parseFloat(pair.priceChange && pair.priceChange.h24 ? pair.priceChange.h24 : 0);

          document.getElementById('tickerPrice').textContent =
            '$' + (price < 0.01 ? price.toFixed(6) : price.toFixed(4));

          const changeEl = document.getElementById('tickerChange');
          const changeText = (change24h >= 0 ? '+' : '') + change24h.toFixed(2) + '%';
          changeEl.textContent = changeText + ' 24h';
          changeEl.className = 'ticker-change ' + (change24h >= 0 ? 'positive' : 'negative');
        }
      } catch (error) {
        console.log('Price fetch failed:', error);
        document.getElementById('tickerPrice').textContent = 'View Chart';
      }
    }
    
    updatePrice();
    setInterval(updatePrice, 30000);

    // ===== Stars with Parallax =====
    const starsContainer = document.getElementById('stars');
    const starElements = [];
    for (let i = 0; i < 100; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * 3 + 1;
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 3 + 's';
      star.dataset.speed = (Math.random() * 0.3).toFixed(2);
      starsContainer.appendChild(star);
      starElements.push(star);
    }

    window.addEventListener('scroll', () => {
      const scrolled = window.pageYOffset;
      starElements.forEach(star => {
        const speed = parseFloat(star.dataset.speed);
        star.style.transform = `translateY(${scrolled * speed}px)`;
      });
    });

    // ===== (3D viewer removed) ===== Hover Lore Typewriter =====
    const loreLines = [
      "I am Wan Shi Tong, a Knowledge Spirit.",
      "I have collected information for over ten thousand years.",
      "Mortals always believe their cause is just.",
      "I was betrayed by those who sought knowledge for war.",
      "My library now exists in the Spirit World, beyond mortal reach.",
      "The foxes serve me, gathering knowledge across the realms.",
      "Those who misuse information face judgment.",
      "I see through all deception with my many eyes."
    ];

    const loreTextEl = document.getElementById('loreText');
    const loreTrigger = document.getElementById('loreTrigger');

    let loreIndex = 0;
    let typing = false;
    let typeTimer = null;

    function typeLine(line) {
      typing = true;
      loreTextEl.textContent = "";
      let i = 0;
      clearInterval(typeTimer);
      typeTimer = setInterval(() => {
        loreTextEl.textContent += line.charAt(i);
        i++;
        if (i >= line.length) {
          clearInterval(typeTimer);
          typing = false;
        }
      }, 25);
    }

    function nextLore() {
      if (typing) return;
      typeLine(loreLines[loreIndex % loreLines.length]);
      loreIndex++;
    }

    loreTrigger.addEventListener('mouseenter', nextLore);
    loreTrigger.addEventListener('focusin', nextLore);
    loreTrigger.addEventListener('click', () => {
      if (typing) {
        clearInterval(typeTimer);
        typing = false;
      } else {
        nextLore();
      }
    });

    typeLine(loreLines[0]);
    loreIndex = 1;

    // ===== Contract Address Copy =====
    const copyBtn = document.getElementById('copyCa');
    const caValue = document.getElementById('caValue');
    const copyStatus = document.getElementById('copyStatus');

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(caValue.textContent.trim());
        copyStatus.textContent = "Copied ‚úì";
        setTimeout(() => (copyStatus.textContent = ""), 1500);
      } catch (e) {
        copyStatus.textContent = "Copy failed";
        setTimeout(() => (copyStatus.textContent = ""), 2500);
      }
    });

    // ===== Social Share Buttons =====
    document.getElementById('shareTwitter').addEventListener('click', () => {
      const text = encodeURIComponent('He Who Knows Ten Thousand Things is about to teach the market a lesson ü¶â\\n\\n$WanShiTong\\nCA: DzmMSKtWmc2vhDxEcD5EH5Qr1MZNYJYZ8uE3UHaxpump');
      const url = encodeURIComponent(window.location.href);
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
    });

    document.getElementById('copyLink').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        const btn = document.getElementById('copyLink');
        const original = btn.textContent;
        btn.textContent = 'Copied ‚úì';
        setTimeout(() => btn.textContent = original, 1500);
      } catch (e) {
        alert('Failed to copy link');
      }
    });

    // ===== AI Offering =====
    const form = document.getElementById('knowledgeForm');
    const aiReply = document.getElementById('aiReply');
    const offerBtn = document.getElementById('offerBtn');

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const knowledge = document.getElementById('knowledge').value.trim();

      aiReply.style.display = 'block';
      aiReply.innerHTML = '<span class="loading-spinner"></span>The Knowledge Spirit considers your offering...';
      offerBtn.disabled = true;
      offerBtn.innerHTML = '<span class="loading-spinner"></span>Judging...';

      try {
        const endpoint = '/.netlify/functions/knowledge';
        if (location.protocol === 'file:') {
          throw new Error('Local preview cannot call Netlify Functions. Use netlify dev or deploy.');
        }

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, knowledge })
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch (_) {}

        if (!res.ok) {
          const msg = (data && (data.reply || data.error)) ? (data.reply || data.error) : `Error (${res.status}).`;
          throw new Error(msg);
        }

        aiReply.textContent = (data && data.reply) ? data.reply : (text || 'The Spirit is silent.');
      } catch (err) {
        aiReply.textContent = 'The Spirit World connection falters... try again.\\n\\n' + err.message;
      } finally {
        offerBtn.disabled = false;
        offerBtn.textContent = 'Present Your Offering';
      }
    });

    // ===== Section click feedback =====
    document.querySelectorAll('.section').forEach(section => {
      section.addEventListener('click', function() {
        this.style.background = 'rgba(61, 35, 20, 0.8)';
        setTimeout(() => {
          this.style.background = 'rgba(61, 35, 20, 0.6)';
        }, 200);
      });
    });

    // ===== Easter Egg =====
    let keySequence = [];
    const secretPhrase = 'sokka';
    window.addEventListener('keydown', (e) => {
      keySequence.push(e.key.toLowerCase());
      if (keySequence.length > secretPhrase.length) keySequence.shift();
      if (keySequence.join('') === secretPhrase) {
        alert('üó°Ô∏è Sokka: "So... this is the spirit that tried to keep us from the Fire Nation info. Knowledge guy, meat guy... we should talk."');
        keySequence = [];
      }
    });
  

    // ===== PFP / Meme Generator (Client-side Canvas) =====
(function() {
  const upload = document.getElementById('pfpUpload');
  const canvas = document.getElementById('pfpCanvas');
  const resetBtn = document.getElementById('pfpReset');
  const dlBtn = document.getElementById('pfpDownload');
  const textInput = document.getElementById('pfpText');
  const clearTextBtn = document.getElementById('pfpClearText');
  const stickerBar = document.getElementById('pfpStickers');
  const presetsBar = document.getElementById('pfpPresets');

  if (!upload || !canvas || !stickerBar) return;

  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const state = {
    baseImg: null,
    baseCrop: { sx:0, sy:0, s:1 },
    textMode: 'bottom', // top | bottom | both
    frame: 'gold',      // none | gold | seal
    stickers: [],       // {img, x,y, w,h, rot, id, key}
    selectedId: null
  };

  const svgSticker = (svg) => 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));

  // Lore sticker pack (all inline SVG; no external assets; runs 100% client-side)
  const STICKERS = [
    { key: 'owl_eyes', label: 'Owl Eyes', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="360" height="180" viewBox="0 0 360 180">
      <defs>
        <radialGradient id="g" cx="50%" cy="50%" r="60%">
          <stop offset="0%" stop-color="#daa520" stop-opacity="0.95"/>
          <stop offset="55%" stop-color="#daa520" stop-opacity="0.35"/>
          <stop offset="100%" stop-color="#000" stop-opacity="0"/>
        </radialGradient>
      </defs>
      <ellipse cx="110" cy="95" rx="88" ry="64" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
      <ellipse cx="250" cy="95" rx="88" ry="64" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
      <circle cx="110" cy="95" r="44" fill="url(#g)"/>
      <circle cx="250" cy="95" r="44" fill="url(#g)"/>
      <circle cx="110" cy="95" r="16" fill="rgba(0,0,0,0.7)"/>
      <circle cx="250" cy="95" r="16" fill="rgba(0,0,0,0.7)"/>
      <circle cx="102" cy="88" r="6" fill="rgba(255,255,255,0.5)"/>
      <circle cx="242" cy="88" r="6" fill="rgba(255,255,255,0.5)"/>
    </svg>`) },
    { key: 'sigil', label: 'Sigil', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="220" height="220" viewBox="0 0 220 220">
      <circle cx="110" cy="110" r="96" fill="rgba(0,0,0,0.45)" stroke="#daa520" stroke-width="10"/>
      <path d="M110 35 L145 95 L110 185 L75 95 Z" fill="none" stroke="#daa520" stroke-width="10" stroke-linejoin="round"/>
      <circle cx="110" cy="110" r="10" fill="#daa520"/>
    </svg>`) },
    { key: 'feather_crown', label: 'Feather Crown', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="360" height="210" viewBox="0 0 360 210">
      <path d="M55 165 C95 80, 140 80, 180 165 C220 80, 265 80, 305 165" fill="none" stroke="#daa520" stroke-width="12" stroke-linecap="round"/>
      <path d="M70 160 C90 120, 120 120, 140 160" fill="none" stroke="rgba(232,213,183,0.65)" stroke-width="8" stroke-linecap="round"/>
      <path d="M220 160 C240 120, 270 120, 290 160" fill="none" stroke="rgba(232,213,183,0.65)" stroke-width="8" stroke-linecap="round"/>
      <circle cx="180" cy="165" r="22" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
    </svg>`) },
    { key: 'scroll', label: 'Scroll', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="260" height="180" viewBox="0 0 260 180">
      <rect x="40" y="35" width="180" height="110" rx="16" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="8"/>
      <path d="M70 70 H190" stroke="#e8d5b7" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
      <path d="M70 95 H175" stroke="#e8d5b7" stroke-width="8" stroke-linecap="round" opacity="0.8"/>
      <path d="M70 120 H160" stroke="#e8d5b7" stroke-width="8" stroke-linecap="round" opacity="0.7"/>
      <circle cx="40" cy="90" r="22" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="8"/>
      <circle cx="220" cy="90" r="22" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="8"/>
    </svg>`) },
    { key: 'tome', label: 'Tome', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="260" height="220" viewBox="0 0 260 220">
      <rect x="55" y="35" width="150" height="160" rx="14" fill="rgba(0,0,0,0.45)" stroke="#daa520" stroke-width="10"/>
      <rect x="75" y="55" width="110" height="120" rx="10" fill="rgba(0,0,0,0.22)" stroke="rgba(218,165,32,0.4)" stroke-width="6"/>
      <path d="M130 72 V178" stroke="#daa520" stroke-width="8" opacity="0.9"/>
      <circle cx="130" cy="120" r="10" fill="#daa520"/>
    </svg>`) },
    { key: 'wax_seal', label: 'Wax Seal', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="260" height="260" viewBox="0 0 260 260">
      <circle cx="130" cy="130" r="110" fill="rgba(0,0,0,0.35)" stroke="#daa520" stroke-width="10"/>
      <circle cx="130" cy="130" r="78" fill="rgba(0,0,0,0.22)" stroke="rgba(218,165,32,0.35)" stroke-width="6"/>
      <text x="130" y="120" font-family="Georgia" font-size="22" text-anchor="middle" fill="#e8d5b7" opacity="0.9">THE LIBRARY</text>
      <text x="130" y="156" font-family="Georgia" font-size="18" text-anchor="middle" fill="#e8d5b7" opacity="0.75">REMEMBERS</text>
    </svg>`) },
    { key: 'chains', label: 'Chains', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="340" height="220" viewBox="0 0 340 220">
      <g fill="none" stroke="#daa520" stroke-width="10" opacity="0.9" stroke-linecap="round">
        <path d="M60 60 C95 25, 145 25, 180 60 C215 95, 215 145, 180 180 C145 215, 95 215, 60 180 C25 145, 25 95, 60 60 Z"/>
        <path d="M160 40 C195 5, 245 5, 280 40 C315 75, 315 125, 280 160 C245 195, 195 195, 160 160 C125 125, 125 75, 160 40 Z"/>
      </g>
      <path d="M140 110 H200" stroke="rgba(232,213,183,0.6)" stroke-width="8" stroke-linecap="round"/>
    </svg>`) },
    { key: 'hourglass', label: 'Hourglass', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="300" viewBox="0 0 200 300">
      <path d="M40 30 H160" stroke="#daa520" stroke-width="12" stroke-linecap="round"/>
      <path d="M40 270 H160" stroke="#daa520" stroke-width="12" stroke-linecap="round"/>
      <path d="M55 45 C70 120, 130 120, 145 45" fill="none" stroke="#daa520" stroke-width="10"/>
      <path d="M55 255 C70 180, 130 180, 145 255" fill="none" stroke="#daa520" stroke-width="10"/>
      <path d="M78 95 C92 120, 108 120, 122 95" fill="none" stroke="rgba(232,213,183,0.8)" stroke-width="8" stroke-linecap="round"/>
      <path d="M78 205 C92 180, 108 180, 122 205" fill="none" stroke="rgba(232,213,183,0.55)" stroke-width="8" stroke-linecap="round"/>
      <circle cx="100" cy="150" r="6" fill="rgba(232,213,183,0.75)"/>
    </svg>`) },
    { key: 'blindfold', label: 'Blindfold', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="360" height="140" viewBox="0 0 360 140">
      <rect x="30" y="50" width="300" height="50" rx="20" fill="rgba(0,0,0,0.55)" stroke="#daa520" stroke-width="8"/>
      <path d="M50 60 C80 20, 120 20, 150 60" fill="none" stroke="rgba(232,213,183,0.35)" stroke-width="6" stroke-linecap="round"/>
      <path d="M210 60 C240 20, 280 20, 310 60" fill="none" stroke="rgba(232,213,183,0.35)" stroke-width="6" stroke-linecap="round"/>
    </svg>`) },
    { key: 'spirit_fog', label: 'Spirit Fog', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="768" height="768" viewBox="0 0 768 768">
      <defs>
        <radialGradient id="f" cx="50%" cy="55%" r="70%">
          <stop offset="0%" stop-color="rgba(232,213,183,0.22)"/>
          <stop offset="60%" stop-color="rgba(232,213,183,0.10)"/>
          <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
        </radialGradient>
      </defs>
      <circle cx="384" cy="420" r="340" fill="url(#f)"/>
      <path d="M90 520 C180 460, 280 620, 380 560 C470 510, 560 610, 680 540" fill="none" stroke="rgba(232,213,183,0.12)" stroke-width="28" stroke-linecap="round"/>
      <path d="M120 600 C220 540, 320 700, 430 640 C520 590, 610 690, 720 620" fill="none" stroke="rgba(232,213,183,0.10)" stroke-width="24" stroke-linecap="round"/>
    </svg>`) },
    { key: 'star_map', label: 'Star Map', src: svgSticker(`<svg xmlns="http://www.w3.org/2000/svg" width="768" height="768" viewBox="0 0 768 768">
      <rect x="0" y="0" width="768" height="768" fill="rgba(0,0,0,0)"/>
      <g fill="#e8d5b7" opacity="0.22">
        <circle cx="120" cy="160" r="3"/><circle cx="180" cy="260" r="2"/><circle cx="310" cy="110" r="2"/>
        <circle cx="520" cy="220" r="3"/><circle cx="640" cy="140" r="2"/><circle cx="610" cy="340" r="2"/>
        <circle cx="420" cy="420" r="3"/><circle cx="250" cy="460" r="2"/><circle cx="140" cy="560" r="3"/>
        <circle cx="340" cy="640" r="2"/><circle cx="560" cy="610" r="3"/><circle cx="680" cy="520" r="2"/>
      </g>
      <g stroke="#daa520" opacity="0.18" stroke-width="3" fill="none">
        <path d="M120 160 L180 260 L310 110"/>
        <path d="M520 220 L640 140 L610 340"/>
        <path d="M140 560 L250 460 L420 420 L560 610 L680 520"/>
      </g>
    </svg>`) }
  ];

  function fitBaseImage(img) {
    const s = Math.min(img.width, img.height);
    const sx = (img.width - s) / 2;
    const sy = (img.height - s) / 2;
    state.baseCrop = { sx, sy, s };
  }

  function drawBase() {
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.fillRect(0, 0, W, H);
    if (!state.baseImg) return;
    const { sx, sy, s } = state.baseCrop;
    ctx.drawImage(state.baseImg, sx, sy, s, s, 0, 0, W, H);
  }

  function drawFrame() {
    if (state.frame === 'none') return;

    if (state.frame === 'gold') {
      const pad = 20;
      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.strokeStyle = '#daa520';
      ctx.lineWidth = 18;
      ctx.beginPath();
      ctx.arc(W/2, H/2, (Math.min(W,H)/2) - pad, 0, Math.PI*2);
      ctx.stroke();

      ctx.globalAlpha = 0.25;
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(W/2, H/2, (Math.min(W,H)/2) - pad - 26, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    if (state.frame === 'seal') {
      ctx.save();
      ctx.strokeStyle = '#daa520';
      ctx.globalAlpha = 0.95;
      ctx.lineWidth = 10;
      const m = 26;
      ctx.strokeRect(m, m, W - m*2, H - m*2);

      ctx.globalAlpha = 0.22;
      ctx.lineWidth = 3;
      ctx.strokeRect(m+18, m+18, W - (m+18)*2, H - (m+18)*2);

      ctx.globalAlpha = 0.9;
      ctx.lineWidth = 10;
      const c = 62;
      const drawCorner = (x,y,dx,dy) => {
        ctx.beginPath(); ctx.moveTo(x, y+dy*c); ctx.lineTo(x, y); ctx.lineTo(x+dx*c, y); ctx.stroke();
      };
      drawCorner(m, m, 1, 1);
      drawCorner(W-m, m, -1, 1);
      drawCorner(m, H-m, 1, -1);
      drawCorner(W-m, H-m, -1, -1);
      ctx.restore();
    }
  }

  function drawText() {
    const text = (textInput.value || '').trim();
    if (!text) return;

    ctx.save();
    ctx.textAlign = 'center';
    ctx.fillStyle = '#e8d5b7';
    ctx.strokeStyle = 'rgba(0,0,0,0.7)';
    ctx.lineWidth = 10;

    let fontSize = 64;
    const maxWidth = W * 0.86;
    do {
      ctx.font = `bold ${fontSize}px Georgia`;
      if (ctx.measureText(text).width <= maxWidth) break;
      fontSize -= 2;
    } while (fontSize > 28);

    const drawLine = (y) => {
      ctx.strokeText(text, W/2, y);
      ctx.fillText(text, W/2, y);
    };

    if (state.textMode === 'top' || state.textMode === 'both') drawLine(90);
    if (state.textMode === 'bottom' || state.textMode === 'both') drawLine(H - 60);

    ctx.restore();
  }

  function drawStickers() {
    for (const s of state.stickers) {
      ctx.save();
      ctx.translate(s.x, s.y);
      ctx.rotate(s.rot || 0);
      ctx.drawImage(s.img, -s.w/2, -s.h/2, s.w, s.h);

      if (s.id === state.selectedId) {
        ctx.strokeStyle = 'rgba(218,165,32,0.9)';
        ctx.lineWidth = 4;
        ctx.strokeRect(-s.w/2, -s.h/2, s.w, s.h);
      }
      ctx.restore();
    }
  }

  function render() {
    drawBase();
    drawStickers();
    drawFrame();
    drawText();
  }

  function addSticker(src, opts = {}) {
    const img = new Image();
    img.onload = () => {
      const base = Math.min(W, H);
      const defaultW = base * (opts.scale ?? 0.28);
      const w = Math.max(40, Math.min(W*0.9, defaultW));
      const h = Math.max(40, Math.min(H*0.9, w * (img.height / img.width)));
      const id = 'st_' + Math.random().toString(16).slice(2);
      const x = opts.x ?? (W/2);
      const y = opts.y ?? (H/2);
      const rot = opts.rot ?? 0;
      state.stickers.push({ img, x, y, w, h, rot, id, key: opts.key || '' });
      state.selectedId = id;
      render();
    };
    img.src = src;
  }

  // Sticker UI buttons
  STICKERS.forEach(st => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn small';
    btn.textContent = st.label;
    btn.addEventListener('click', () => addSticker(st.src, { key: st.key }));
    stickerBar.appendChild(btn);
  });

  // Presets (minimal, lore-forward)
  const PRESETS = [
    {
      label: 'The Librarian',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'gold';
        state.textMode = 'bottom';
        textInput.value = '$WanShiTong';
        // Seal + Sigil
        const seal = STICKERS.find(s => s.key === 'wax_seal');
        const sigil = STICKERS.find(s => s.key === 'sigil');
        if (seal) addSticker(seal.src, { key: seal.key, x: W*0.23, y: H*0.78, scale: 0.30 });
        if (sigil) addSticker(sigil.src, { key: sigil.key, x: W*0.78, y: H*0.78, scale: 0.24 });
        render();
      }
    },
    {
      label: 'Forbidden Knowledge',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'seal';
        state.textMode = 'both';
        textInput.value = 'THE LIBRARY REMEMBERS';
        const fog = STICKERS.find(s => s.key === 'spirit_fog');
        const starmap = STICKERS.find(s => s.key === 'star_map');
        const chains = STICKERS.find(s => s.key === 'chains');
        const scroll = STICKERS.find(s => s.key === 'scroll');
        if (starmap) addSticker(starmap.src, { key: starmap.key, x: W/2, y: H/2, scale: 0.98 });
        if (fog) addSticker(fog.src, { key: fog.key, x: W/2, y: H/2, scale: 0.98 });
        if (chains) addSticker(chains.src, { key: chains.key, x: W/2, y: H*0.78, scale: 0.62 });
        if (scroll) addSticker(scroll.src, { key: scroll.key, x: W*0.78, y: H*0.26, scale: 0.30 });
        render();
      }
    },
    {
      label: 'The Judge',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'gold';
        state.textMode = 'top';
        textInput.value = 'NO WAR IN THE LIBRARY';
        const blind = STICKERS.find(s => s.key === 'blindfold');
        const hour = STICKERS.find(s => s.key === 'hourglass');
        const seal = STICKERS.find(s => s.key === 'wax_seal');
        if (blind) addSticker(blind.src, { key: blind.key, x: W/2, y: H*0.36, scale: 0.62 });
        if (hour) addSticker(hour.src, { key: hour.key, x: W*0.82, y: H*0.60, scale: 0.30 });
        if (seal) addSticker(seal.src, { key: seal.key, x: W*0.20, y: H*0.78, scale: 0.28 });
        render();
      }
    },
    {
      label: 'The Archivist',
      apply() {
        state.stickers = [];
        state.selectedId = null;
        state.frame = 'seal';
        state.textMode = 'bottom';
        textInput.value = '$WanShiTong';
        const tome = STICKERS.find(s => s.key === 'tome');
        const crown = STICKERS.find(s => s.key === 'feather_crown');
        const eyes = STICKERS.find(s => s.key === 'owl_eyes');
        if (crown) addSticker(crown.src, { key: crown.key, x: W/2, y: H*0.16, scale: 0.64 });
        if (eyes) addSticker(eyes.src, { key: eyes.key, x: W/2, y: H*0.40, scale: 0.70 });
        if (tome) addSticker(tome.src, { key: tome.key, x: W*0.82, y: H*0.80, scale: 0.30 });
        render();
      }
    }
  ];

  if (presetsBar) {
    PRESETS.forEach(p => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn small';
      btn.textContent = p.label;
      btn.addEventListener('click', p.apply);
      presetsBar.appendChild(btn);
    });
  }

  // Upload
  upload.addEventListener('change', e => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => {
      state.baseImg = img;
      fitBaseImage(img);
      state.stickers = [];
      state.selectedId = null;
      render();
    };
    img.src = URL.createObjectURL(file);
  });

  // Text mode buttons
  document.querySelectorAll('[data-textstyle]').forEach(btn => {
    btn.addEventListener('click', () => { state.textMode = btn.getAttribute('data-textstyle'); render(); });
  });

  // Frame buttons
  document.querySelectorAll('[data-frame]').forEach(btn => {
    btn.addEventListener('click', () => { state.frame = btn.getAttribute('data-frame'); render(); });
  });

  clearTextBtn.addEventListener('click', () => { textInput.value = ''; render(); });
  textInput.addEventListener('input', () => render());

  // Drag/select
  let dragging = false;
  let dragOffset = {x:0,y:0};

  function hitTest(x,y) {
    for (let i = state.stickers.length - 1; i >= 0; i--) {
      const s = state.stickers[i];
      // approximate AABB (ignoring rotation)
      if (x >= s.x - s.w/2 && x <= s.x + s.w/2 && y >= s.y - s.h/2 && y <= s.y + s.h/2) return s;
    }
    return null;
  }

  function getPos(ev) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width;
    const scaleY = H / rect.height;
    return { x: (ev.clientX - rect.left) * scaleX, y: (ev.clientY - rect.top) * scaleY };
  }

  canvas.addEventListener('mousedown', ev => {
    const p = getPos(ev);
    const s = hitTest(p.x,p.y);
    if (!s) { state.selectedId = null; render(); return; }
    state.selectedId = s.id;
    // bring to top
    state.stickers = state.stickers.filter(x => x.id !== s.id).concat([s]);
    dragging = true;
    dragOffset = { x: p.x - s.x, y: p.y - s.y };
    render();
  });

  window.addEventListener('mousemove', ev => {
    if (!dragging) return;
    const p = getPos(ev);
    const s = state.stickers.find(x => x.id === state.selectedId);
    if (!s) return;
    s.x = p.x - dragOffset.x;
    s.y = p.y - dragOffset.y;
    render();
  });

  window.addEventListener('mouseup', () => dragging = false);

  // Wheel to resize selected sticker
  canvas.addEventListener('wheel', ev => {
    const s = state.stickers.find(x => x.id === state.selectedId);
    if (!s) return;
    ev.preventDefault();
    const delta = Math.sign(ev.deltaY);
    const factor = delta > 0 ? 0.94 : 1.06;
    s.w = Math.max(40, Math.min(W*0.95, s.w * factor));
    s.h = Math.max(40, Math.min(H*0.95, s.h * factor));
    render();
  }, { passive: false });

  // Delete key removes selected sticker
  window.addEventListener('keydown', ev => {
    if (ev.key !== 'Delete' && ev.key !== 'Backspace') return;
    if (!state.selectedId) return;
    state.stickers = state.stickers.filter(s => s.id !== state.selectedId);
    state.selectedId = null;
    render();
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    state.baseImg = null;
    state.stickers = [];
    state.selectedId = null;
    state.textMode = 'bottom';
    state.frame = 'gold';
    textInput.value = '$WanShiTong';
    upload.value = '';
    render();
  });

  // Download
  dlBtn.addEventListener('click', () => {
    render();
    const a = document.createElement('a');
    a.download = 'WanShiTong-PFP.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  // First render
  render();
})();
  </script>
  <script src="js/objviewer.js"></script>
  <script>
    // ===== 3D Model Viewer =====
    // MODEL_PATHS: update these if you rename files in /models/
    const MODEL_PATHS = {
      obj: "models/wanshi.obj",
      mtl: "models/wanshi.mtl"
    };

    window.addEventListener("load", () => {
      try {
        if (typeof initWanShiViewer !== "function") {
          const s = document.getElementById("modelStatus");
          if (s) s.textContent = "3D viewer failed to initialize (missing viewer script).";
          return;
        }
        initWanShiViewer({
          canvasId: "threeCanvas",
          statusId: "modelStatus",
          objPath: MODEL_PATHS.obj,
          mtlPath: MODEL_PATHS.mtl
        });
      } catch (e) {
        const s = document.getElementById("modelStatus");
        if (s) s.textContent = "3D viewer error: " + (e && e.message ? e.message : String(e));
      }
    });
  </script>

<script>
/* ===== Added: Spirit Runner (fixed timestep + HiDPI), Meme Library, Spirit Awaken ===== */
(() => {
  // ---- Spirit Runner ----
  const c = document.getElementById('wstRunnerCanvas');
  if (!c) return;
  const ctx = c.getContext('2d');

  const ui = {
    score: document.getElementById('wstScore'),
    best: document.getElementById('wstBest'),
    whirl: document.getElementById('wstWhirl'),
    start: document.getElementById('wstStartBtn'),
    restart: document.getElementById('wstRestartBtn'),
    submit: document.getElementById('wstSubmitBtn'),
    share: document.getElementById('wstShareBtn'),
    lb: document.getElementById('wstRunnerLbList')
  };

  // HiDPI scale
  function fitCanvas(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const cssW = c.clientWidth || 960;
    const cssH = Math.round(cssW * (260/960));
    c.style.height = cssH + 'px';
    c.width  = Math.round(cssW * dpr);
    c.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  requestAnimationFrame(fitCanvas);
  window.addEventListener('resize', () => requestAnimationFrame(fitCanvas));

  // Game state
  let running = false;
  let score = 0;
  let best = Number(localStorage.getItem('wst_runner_best') || 0);
  ui.best.textContent = String(best);

  const K = new Set();
  window.addEventListener('keydown', (e) => {
    const k = e.code;
    if (k === 'ArrowLeft' || k === 'ArrowRight' || k === 'Space' || k === 'KeyX' || k === 'KeyR'){
      K.add(k);
      if (k === 'KeyR') reset();
      e.preventDefault();
    }
  }, {passive:false});
  window.addEventListener('keyup', (e) => K.delete(e.code));

  // Tuned slower + smoother
  const GRAV = 2200;
  const JUMP = 860;
  const MOVE = 520;        // slower
  const GROUND = 208;      // y in CSS px space (not DPR)
  const FIRE_MIN_GAP = 260; // more spacing
  const FIRE_SPEED = 240;  // slower fire

  const owl = { x: 80, y: GROUND, vy: 0, on: true, r: 18 };
  let fires = [];
  let spawnX = 980;

  // Whirlwind
  let whirlCooldown = 0; // seconds
  const WHIRL_CD = 3.5;
  const WHIRL_RADIUS = 210;

  function reset(){
    running = false;
    score = 0;
    owl.x = 80; owl.y = GROUND; owl.vy = 0; owl.on = true;
    fires = [];
    spawnX = 980;
    whirlCooldown = 0;
    ui.score.textContent = '0';
    ui.whirl.textContent = 'Ready';
  }

  function start(){
    if (!running) running = true;
  }

  ui.start?.addEventListener('click', start);
  ui.restart?.addEventListener('click', reset);

  function rand(min,max){ return min + Math.random()*(max-min); }

  function spawnFire(){
    // Ensure spacing by spawnX
    const h = rand(22, 34);
    fires.push({ x: spawnX, y: GROUND- (h/2), w: rand(22, 30), h, alive:true });
    spawnX += FIRE_MIN_GAP + rand(0, 160);
  }

  // collision circle vs rect
  function hitCircleRect(cx,cy,cr, r){
    const nx = Math.max(r.x, Math.min(cx, r.x + r.w));
    const ny = Math.max(r.y - r.h/2, Math.min(cy, (r.y - r.h/2) + r.h));
    const dx = cx - nx, dy = cy - ny;
    return (dx*dx + dy*dy) <= cr*cr;
  }

  function drawBG(w,h,t){
    // dunes + embers
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(0,0,0,0.10)';
    ctx.fillRect(0,0,w,h);

    // dunes
    ctx.fillStyle = 'rgba(218,165,32,0.08)';
    ctx.beginPath();
    ctx.moveTo(0, h);
    ctx.quadraticCurveTo(w*0.25, h-24, w*0.5, h-10);
    ctx.quadraticCurveTo(w*0.75, h+6, w, h-18);
    ctx.lineTo(w,h); ctx.closePath();
    ctx.fill();

    // snow specks (mystic)
    ctx.fillStyle = 'rgba(255,255,255,0.20)';
    for(let i=0;i<40;i++){
      const x = (i*79 + t*30) % (w+40) - 20;
      const y = (i*41 + t*55) % (h+40) - 20;
      ctx.beginPath();
      ctx.arc(x,y,(i%3)+0.6,0,Math.PI*2);
      ctx.fill();
    }
  }

  function drawOwl(){
    // Emoji owl
    ctx.font = '32px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ü¶â', owl.x, owl.y-18);
  }

  function drawFire(f,t){
    // stylized flame (outer+inner + sparks), less blocky
    const baseX = f.x, baseY = f.y;
    const pulse = 0.75 + 0.25*Math.sin(t*10 + baseX*0.01);
    // outer
    ctx.fillStyle = `rgba(255,80,80,${0.55*pulse})`;
    ctx.beginPath();
    ctx.ellipse(baseX, baseY, f.w*0.9, f.h*0.55, 0, 0, Math.PI*2);
    ctx.fill();
    // inner
    ctx.fillStyle = `rgba(255,200,120,${0.35*pulse})`;
    ctx.beginPath();
    ctx.ellipse(baseX, baseY-2, f.w*0.55, f.h*0.35, 0, 0, Math.PI*2);
    ctx.fill();
    // sparks
    ctx.fillStyle = `rgba(255,255,255,${0.08*pulse})`;
    for(let i=0;i<3;i++){
      const sx = baseX + (i-1)*6 + Math.sin(t*8+i)*3;
      const sy = baseY - f.h*0.6 - (i*4) + (Math.cos(t*7+i)*2);
      ctx.fillRect(sx, sy, 2, 2);
    }
  }

  function drawWhirl(t){
    // whirlwind ring effect around owl when casting
    ctx.strokeStyle = 'rgba(122,255,192,0.35)';
    ctx.lineWidth = 2;
    for(let i=0;i<3;i++){
      const r = 34 + i*10 + Math.sin(t*10+i)*2;
      ctx.beginPath();
      ctx.arc(owl.x, owl.y-18, r, 0, Math.PI*2);
      ctx.stroke();
    }
    ctx.lineWidth = 1;
  }

  // Leaderboard local
  const LB_KEY = 'wst_runner_lb_v1';
  function loadLB(){
    try { return JSON.parse(localStorage.getItem(LB_KEY) || '[]'); } catch { return []; }
  }
  function saveLB(arr){
    localStorage.setItem(LB_KEY, JSON.stringify(arr.slice(0,10)));
  }
  function renderLB(){
    const arr = loadLB();
    ui.lb.innerHTML = '';
    if (!arr.length){
      const li = document.createElement('li');
      li.style.justifyContent = 'center';
      li.textContent = 'No scores yet. Be the first.';
      ui.lb.appendChild(li);
      return;
    }
    arr.forEach((s,i)=>{
      const li = document.createElement('li');
      li.innerHTML = `<span>#${i+1} ${s.name}</span><span>${s.score}</span>`;
      ui.lb.appendChild(li);
    });
  }
  renderLB();

  ui.submit?.addEventListener('click', () => {
    const name = (prompt('Name for the Library ledger?') || '').trim().slice(0,18);
    if (!name) return;
    const arr = loadLB();
    arr.push({ name, score });
    arr.sort((a,b)=>b.score-a.score);
    saveLB(arr);
    renderLB();
  });

  ui.share?.addEventListener('click', () => {
    const txt = encodeURIComponent(`I survived Wan Shi Tong: Spirit Runner with a score of ${score}. ü¶âüî• #WanShiTong`);
    window.open(`https://twitter.com/intent/tweet?text=${txt}`, '_blank');
  });

  // fixed timestep loop
  let last = performance.now();
  let acc = 0;
  const step = 1/60;

  function update(dt){
    if (!running) return;

    // movement (optional left/right but slow)
    if (K.has('ArrowLeft')) owl.x = Math.max(30, owl.x - MOVE*dt);
    if (K.has('ArrowRight')) owl.x = Math.min((c.clientWidth||960)-30, owl.x + MOVE*dt);

    // jump
    if ((K.has('Space')) && owl.on){
      owl.vy = -JUMP;
      owl.on = false;
    }

    owl.vy += GRAV*dt;
    owl.y += owl.vy*dt;

    if (owl.y >= GROUND){
      owl.y = GROUND;
      owl.vy = 0;
      owl.on = true;
    }

    // cooldown
    whirlCooldown = Math.max(0, whirlCooldown - dt);
    ui.whirl.textContent = whirlCooldown <= 0 ? 'Ready' : `${whirlCooldown.toFixed(1)}s`;

    // cast whirlwind
    if (K.has('KeyX') && whirlCooldown <= 0){
      whirlCooldown = WHIRL_CD;
      // clear fires within radius
      const cx = owl.x, cy = owl.y-18;
      fires.forEach(f=>{
        const dx = f.x - cx;
        const dy = (f.y) - cy;
        if (Math.sqrt(dx*dx + dy*dy) <= WHIRL_RADIUS) f.alive = false;
      });
    }

    // spawn fires ahead
    const w = (c.clientWidth || 960);
    if (fires.length < 6 && (fires.length === 0 || (spawnX - (fires[fires.length-1]?.x || 0)) >= FIRE_MIN_GAP)){
      if (spawnX < w + 600) spawnFire();
    }

    // move fires left
    fires.forEach(f => f.x -= FIRE_SPEED*dt);
    fires = fires.filter(f => f.x > -80 && f.alive);

    // scoring over time
    score += dt * 10; // slower scoring
    ui.score.textContent = String(Math.floor(score));

    // collisions
    for (const f of fires){
      if (!f.alive) continue;
      if (hitCircleRect(owl.x, owl.y-18, owl.r, f)){
        running = false;
        // banished message overlay (simple)
      }
    }

    // best
    const sInt = Math.floor(score);
    if (sInt > best){
      best = sInt;
      localStorage.setItem('wst_runner_best', String(best));
      ui.best.textContent = String(best);
    }
  }

  function draw(now){
    const w = c.clientWidth || 960;
    const h = parseInt(c.style.height || '260',10) || 260;
    drawBG(w,h, now/1000);

    // ground line
    ctx.strokeStyle = 'rgba(218,165,32,0.22)';
    ctx.beginPath();
    ctx.moveTo(0, GROUND+1);
    ctx.lineTo(w, GROUND+1);
    ctx.stroke();

    // fires
    fires.forEach(f=> drawFire(f, now/1000));

    // owl
    drawOwl();

    // whirlwind visual when cooling (brief hint)
    if (whirlCooldown > (WHIRL_CD-0.18)) drawWhirl(now/1000);

    // status overlay
    if (!running){
      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle = 'rgba(232,227,214,0.90)';
      ctx.font = '22px ui-monospace, monospace';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const msg = (score > 0) ? 'Banished.' : 'Press Start.';
      ctx.fillText(msg, w/2, h/2 - 10);
      ctx.font = '13px ui-monospace, monospace';
      ctx.fillStyle = 'rgba(232,227,214,0.75)';
      ctx.fillText('Space to jump ‚Ä¢ X to whirlwind ‚Ä¢ R to restart', w/2, h/2 + 16);
    }
  }

  function loop(now){
    const dt = Math.min(0.05, (now - last)/1000);
    last = now;
    acc += dt;
    while (acc >= step){
      update(step);
      acc -= step;
    }
    draw(now);
    requestAnimationFrame(loop);
  }

  reset();
  requestAnimationFrame(loop);

  // ---- Meme Library ----
  const memeImg = document.getElementById('wstMemeImg');
  const memeCap = document.getElementById('wstMemeCaption');
  const prevBtn = document.getElementById('wstPrevBtn');
  const nextBtn = document.getElementById('wstNextBtn');
  const randBtn = document.getElementById('wstRandBtn');
  const copyBtn = document.getElementById('wstCopyBtn');
  const shareMemeBtn = document.getElementById('wstShareMemeBtn');

  const MEMES = [
    {src:'memes/page-001.jpg', cap:'Page 001 ‚Äî The first forbidden page is always the loudest.'},
    {src:'memes/page-002.jpg', cap:'Page 002 ‚Äî The Librarian approves of receipts.'},
    {src:'memes/page-003.jpg', cap:'Page 003 ‚Äî Enter quietly. Leave louder.'},
    {src:'memes/page-004.jpg', cap:'Page 004 ‚Äî Knowledge is a weapon. Use it wrong and pay.'},
    {src:'memes/page-005.jpg', cap:'Page 005 ‚Äî The archive remembers everything.'},
    {src:'memes/page-006.jpg', cap:'Page 006 ‚Äî The Spirit World does not forget volume.'}
  ];
  let mi = 0;
  function showM(i){
    mi = (i + MEMES.length) % MEMES.length;
    const m = MEMES[mi];
    if (memeImg) memeImg.src = m.src;
    if (memeCap) memeCap.textContent = m.cap;
  }
  prevBtn?.addEventListener('click', ()=>showM(mi-1));
  nextBtn?.addEventListener('click', ()=>showM(mi+1));
  randBtn?.addEventListener('click', ()=>showM(Math.floor(Math.random()*MEMES.length)));
  copyBtn?.addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(MEMES[mi].cap); }
    catch { /* ignore */ }
  });
  shareMemeBtn?.addEventListener('click', ()=>{
    const txt = encodeURIComponent(MEMES[mi].cap + ' #WanShiTong');
    window.open(`https://twitter.com/intent/tweet?text=${txt}`, '_blank');
  });
  showM(0);

  // ---- Spirit Awaken ----
  const awakenBtn = document.getElementById('wstAwakenBtn');
  const wrap = document.getElementById('wstSpiritImgWrap');
  awakenBtn?.addEventListener('click', ()=>{
    if (!wrap) return;
    wrap.classList.toggle('awakened');
    awakenBtn.textContent = wrap.classList.contains('awakened') ? 'Return to Silence' : 'Awaken';
  });
})();
</script>

</body>
</html>
